import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, query, setDoc, updateDoc } from 'firebase/firestore';
import { 
  XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, AreaChart, Area 
} from 'recharts';
import { 
  ShieldAlert, TrendingUp, Crosshair, History, Save, Trash2, 
  RefreshCcw, LayoutDashboard, Calculator, Wallet, Settings, User, CheckCircle, PieChart, ChevronDown, ChevronUp, BookOpen, Target, ArrowRightCircle, Edit2, X, Calendar, AlertCircle, BarChart3, Landmark, Info, Fingerprint, CreditCard, Quote
} from 'lucide-react';

// --- Firebase é…ç½® ---
const firebaseConfig = {
  apiKey: "AIzaSyBpax3wlTwHTe6G3niZajtTxpoUWbgvX80",
  authDomain: "qldmax.firebaseapp.com",
  projectId: "qldmax",
  storageBucket: "qldmax.firebasestorage.app",
  messagingSenderId: "752199866954",
  appId: "1:752199866954:web:50d17ae522095c363d64b3"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'qqq-ibit-v23-tracker';
const FINNHUB_API_KEY = "d4q36b9r01qha6q0jclgd4q36b9r01qha6q0jcm0";

// --- æ‰‹æ©Ÿå„ªåŒ– UI å…ƒä»¶ ---
const Card = ({ children, className = "" }) => (
  <div className={`bg-white dark:bg-slate-800 rounded-3xl shadow-sm border border-slate-100 dark:border-slate-700 p-5 ${className}`}>
    {children}
  </div>
);

const SectionTitle = ({ children, icon: Icon }) => (
  <h2 className="text-[13px] font-black text-slate-400 dark:text-slate-500 mb-3 flex items-center gap-2 px-1 uppercase tracking-[0.1em] text-left">
    {Icon && <Icon size={14} />} {children}
  </h2>
);

const App = () => {
  const [user, setUser] = useState(null);
  const [view, setView] = useState('dashboard');
  const [prices, setPrices] = useState({ QQQ: 0, QLD: 0, TQQQ: 0, IBIT: 0 });
  const [loadingPrices, setLoadingPrices] = useState(false);
  const [isWhitepaperOpen, setIsWhitepaperOpen] = useState(false);
  
  const [filterMode, setFilterMode] = useState('all');
  const [deletingId, setDeletingId] = useState(null);
  const [editingId, setEditingId] = useState(null);
  const [editForm, setEditForm] = useState(null);

  const [customSyncId, setCustomSyncId] = useState(() => localStorage.getItem('qqq_sync_id') || '');
  const [tempSyncId, setTempSyncId] = useState(customSyncId);
  const effectiveUserId = customSyncId || (user ? user.uid : null);

  const [inputs, setInputs] = useState({
    qqq_ema5: 0, qqq_ema12: 0, qqq_ema25: 0, qqq_ath: 0,
    ibit_ema50: 0, current_positions: 'CASH',
    qty_qqq: 0, qty_qld: 0, qty_tqqq: 0, qty_ibit: 0, cash_balance: 0,
    record_date: new Date().toISOString().split('T')[0],
    loan_amount: 0, loan_rate: 2.0, loan_years: 7, loan_repay_target: 20,
    motto: ''
  });

  const [records, setRecords] = useState([]);

  // --- 1. è¨ˆç®—è³‡ç”¢ç¸½é¡ ---
  const calculatedTotalCapital = useMemo(() => {
    return (prices.QQQ * (parseFloat(inputs.qty_qqq) || 0)) + 
           (prices.QLD * (parseFloat(inputs.qty_qld) || 0)) + 
           (prices.TQQQ * (parseFloat(inputs.qty_tqqq) || 0)) + 
           (prices.IBIT * (parseFloat(inputs.qty_ibit) || 0)) + 
           (parseFloat(inputs.cash_balance) || 0);
  }, [prices, inputs]);

  // --- 2. èº«ä»½é©—è­‰ ---
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          try { await signInWithCustomToken(auth, __initial_auth_token); } 
          catch (e) { await signInAnonymously(auth); }
        } else { await signInAnonymously(auth); }
      } catch (err) { console.error("Auth failed:", err); }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // --- 3. æ•¸æ“šåŒæ­¥æ ¸å¿ƒ ---
  useEffect(() => {
    if (!effectiveUserId) return;

    const q = query(collection(db, 'artifacts', appId, 'users', effectiveUserId, 'trading_records'));
    const unsubscribeRecords = onSnapshot(q, (snapshot) => {
      const recs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      recs.sort((a, b) => new Date(b.date) - new Date(a.date));
      setRecords(recs);
    });

    const configDocRef = doc(db, 'artifacts', appId, 'users', effectiveUserId, 'config', 'current');
    const unsubscribeConfig = onSnapshot(configDocRef, (snapshot) => {
      if (snapshot.exists()) {
        const cloudData = snapshot.data();
        setInputs(prev => ({ 
          ...prev, 
          ...cloudData,
          record_date: new Date().toISOString().split('T')[0]
        }));
      }
    });

    return () => { unsubscribeRecords(); unsubscribeConfig(); };
  }, [effectiveUserId]);

  // --- 4. å¸‚åƒ¹æŠ“å– ---
  const fetchPrices = async () => {
    if (loadingPrices) return;
    setLoadingPrices(true);
    const symbols = ['QQQ', 'QLD', 'TQQQ', 'IBIT'];
    const newPrices = { ...prices };
    try {
      for (const symbol of symbols) {
        const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${FINNHUB_API_KEY}`);
        const data = await res.json();
        newPrices[symbol] = data.c || 0;
      }
      setPrices(newPrices);
    } catch (err) { console.error("Price error:", err); } 
    finally { setLoadingPrices(false); }
  };

  useEffect(() => { fetchPrices(); const interval = setInterval(fetchPrices, 60000); return () => clearInterval(interval); }, []);

  // --- 5. æˆ°ç•¥åˆ†æå»ºè­° (å·²ç§»é™¤è²¸æ¬¾æ–‡å­—) ---
  const analysis = useMemo(() => {
    const qqq = prices.QQQ;
    const { qqq_ema5, qqq_ema12, qqq_ema25, qqq_ath, current_positions } = inputs;
    if (!qqq || !qqq_ema25) return { coreRecommendation: "æ•¸æ“šè¼‰å…¥ä¸­...", reason: "è«‹å¡«å¯«é€±ç·šæ•¸å€¼ä¸¦æ›´æ–°å¸‚åƒ¹ã€‚", alertLevel: "info" };

    const isBelowSurvival = qqq < (qqq_ema25 * 0.97);
    const isSlopeUp = qqq_ema5 > qqq_ema12;
    const drawdown = qqq_ath > 0 ? (qqq_ath - qqq) / qqq_ath : 0;
    const isSniperZone = drawdown > 0.08 && isSlopeUp;
    const isReachATH = qqq >= (qqq_ath * 0.98);
    const isMomentumLost = qqq < qqq_ema5;

    let coreRec = "QLD";
    let coreRecommendation = "QLD (2x)";
    let reason = "å¤šé ­è¶¨å‹¢å‘ä¸Šï¼Œç¶­æŒ 2 å€æ§“æ¡¿å·¡èˆªæ¨¡å¼ã€‚";
    let alertLevel = "info";

    if (isBelowSurvival) { 
      coreRec = "CASH"; coreRecommendation = "CASH (100% ç¾é‡‘)"; 
      reason = "âš ï¸ è·Œç ´ 25EMA ç”Ÿæ­»ç·š (-3%)ï¼ç«‹å³å¼·åˆ¶æ¸…å€‰é¿é–‹å¤§å´©ç›¤ã€‚"; alertLevel = "error"; 
    } else if (isSniperZone) { 
      coreRec = "TQQQ"; coreRecommendation = "TQQQ (3x)"; 
      reason = "ğŸ”¥ å›èª¿è¶…é 8% ä¸”è¶¨å‹¢å‘ä¸Šï¼Œè§¸ç™¼æ·±å‘ç‹™æ“Šé»ã€‚"; alertLevel = "success"; 
    } else if (!isSlopeUp) { 
      coreRec = "QQQ"; coreRecommendation = "QQQ (1x)"; 
      reason = "ğŸ“‰ 5/12 é€±æ–œç‡å‘ä¸‹ï¼Œä¸»å‹•é™è‡³ 1x é¿é–‹ç›¤æ•´æè€—ã€‚"; alertLevel = "warning"; 
    } else if (current_positions === 'TQQQ' && (isReachATH || isMomentumLost)) {
      coreRec = "QLD"; coreRecommendation = "QLD (2x)";
      reason = isReachATH ? "ğŸ’° åƒ¹æ ¼å·²ä¿®å¾©è‡³é«˜é» 98%ï¼Œç²åˆ©äº†çµæ›å› QLDã€‚" : "âš ï¸ å‹•èƒ½æ¶ˆå¤± (è·Œç ´ 5EMA)ï¼Œæ’¤é€€å› QLDã€‚";
      alertLevel = "warning";
    }

    const actionLabel = current_positions === coreRec ? "[ çºŒæŠ±ä¸­ ]" : "[ åŸ·è¡Œæ›å€‰ ]";
    return { coreRecommendation: `${actionLabel} ${coreRecommendation}`, reason, alertLevel };
  }, [prices, inputs]);

  // --- 6. æ“ä½œåŠŸèƒ½ ---
  const saveRecord = async () => {
    if (!effectiveUserId) return;
    const d = new Date(inputs.record_date); d.setHours(12, 0, 0, 0);
    const record = { 
      date: d.toISOString(), 
      total_equity: calculatedTotalCapital, 
      core_pos: analysis.coreRecommendation, 
      sat_pos: prices.IBIT > inputs.ibit_ema50 ? 'IBIT' : 'CASH', 
      prices: { ...prices }, 
      inputs: { ...inputs } 
    };
    try {
      await addDoc(collection(db, 'artifacts', appId, 'users', effectiveUserId, 'trading_records'), record);
      await setDoc(doc(db, 'artifacts', appId, 'users', effectiveUserId, 'config', 'current'), inputs, { merge: true });
      alert("æ­·å²ç´€éŒ„å·²å­˜æª”ï¼Œæ•¸æ“šåŒæ­¥è¨˜æ†¶æˆåŠŸï¼");
    } catch (e) { alert("å„²å­˜å¤±æ•—"); }
  };

  const startEdit = (rec) => {
    setEditingId(rec.id);
    setEditForm({ ...rec, date: rec.date.split('T')[0], inputs: rec.inputs || { ...inputs } });
  };

  const updateRecord = async (id) => {
    if (!effectiveUserId || !editForm) return;
    try {
      const d = new Date(editForm.date); d.setHours(12, 0, 0, 0);
      const histPrices = editForm.prices || prices;
      const newTotal = (histPrices.QQQ * (parseFloat(editForm.inputs.qty_qqq) || 0)) + 
                       (histPrices.QLD * (parseFloat(editForm.inputs.qty_qld) || 0)) + 
                       (histPrices.TQQQ * (parseFloat(editForm.inputs.qty_tqqq) || 0)) + 
                       (histPrices.IBIT * (parseFloat(editForm.inputs.qty_ibit) || 0)) + 
                       (parseFloat(editForm.inputs.cash_balance) || 0);

      await updateDoc(doc(db, 'artifacts', appId, 'users', effectiveUserId, 'trading_records', id), {
        date: d.toISOString(),
        inputs: editForm.inputs,
        total_equity: newTotal
      });
      setEditingId(null);
      alert("ç·¨è¼¯æˆåŠŸï¼Œè³‡ç”¢ç¸½é¡å·²è‡ªå‹•æ›´æ–°ã€‚");
    } catch (e) { alert("æ›´æ–°å¤±æ•—"); }
  };

  const confirmDelete = async (id) => {
    if (!effectiveUserId) return;
    try {
      await deleteDoc(doc(db, 'artifacts', appId, 'users', effectiveUserId, 'trading_records', id));
      setDeletingId(null);
    } catch (e) { alert("åˆªé™¤å¤±æ•—"); }
  };

  const handleInputChange = (f, v) => setInputs(prev => ({ ...prev, [f]: (typeof prev[f] === 'number') ? (v === '' ? 0 : parseFloat(v)) : v }));
  const syncToCloud = async (f, v) => {
    if (!effectiveUserId) return;
    const val = (typeof inputs[f] === 'number') ? parseFloat(v) || 0 : v;
    try { await setDoc(doc(db, 'artifacts', appId, 'users', effectiveUserId, 'config', 'current'), { [f]: val }, { merge: true }); } catch (e) {}
  };

  const applySyncId = () => {
    const newId = tempSyncId.trim();
    setCustomSyncId(newId);
    localStorage.setItem('qqq_sync_id', newId);
    setView('dashboard');
    alert(newId ? `å·²æˆåŠŸé€£çµ ID: ${newId}ï¼Œæ­£åœ¨æ‹‰å–é›²ç«¯è¨˜æ†¶æ•¸æ“š...` : "å·²å›æ­¸åŒ¿åæ¨¡å¼ã€‚");
  };

  const stats = useMemo(() => {
    if (records.length < 1) return { start: 0, end: 0, growth: 0, filteredList: [] };
    const filtered = records.filter(r => {
      const d = new Date(r.date);
      if (filterMode === 'year') return d.getFullYear() === new Date().getFullYear();
      if (filterMode === 'month') return d.getFullYear() === new Date().getFullYear() && d.getMonth() === new Date().getMonth();
      return true;
    });
    if (filtered.length < 1) return { start: 0, end: 0, growth: 0, filteredList: [] };
    const sorted = [...filtered].sort((a, b) => new Date(a.date) - new Date(b.date));
    const start = sorted[0].total_equity;
    const end = sorted[sorted.length - 1].total_equity;
    const growth = start > 0 ? ((end - start) / start) * 100 : 0;
    return { start, end, growth, filteredList: filtered };
  }, [records, filterMode]);

  return (
    <div className="min-h-screen bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-slate-100 font-sans pb-32">
      {/* é é¦– */}
      <header className="bg-white/80 dark:bg-slate-800/80 backdrop-blur-md border-b dark:border-slate-700 sticky top-0 z-30 px-5 py-4 flex justify-between items-center">
        <div className="flex items-center gap-2">
          <div className="bg-indigo-600 p-2 rounded-2xl shadow-lg shadow-indigo-200 dark:shadow-none"><TrendingUp className="text-white" size={18} /></div>
          <h1 className="font-black text-lg tracking-tight uppercase">QQQ v2.4</h1>
        </div>
        <div className="flex items-center gap-1">
          <button onClick={() => setView('sync_settings')} className={`p-3 rounded-full transition-all ${view === 'sync_settings' ? 'bg-indigo-100 text-indigo-600 scale-110' : 'text-slate-400'}`}><Settings size={22} /></button>
          <button onClick={fetchPrices} className={`p-3 rounded-full transition-all ${loadingPrices ? 'animate-spin' : 'text-slate-400 active:rotate-180'}`}><RefreshCcw size={22} /></button>
        </div>
      </header>

      <main className="max-w-md mx-auto p-4 sm:p-6 space-y-6">
        {view === 'sync_settings' && (
          <div className="space-y-6 animate-in fade-in slide-in-from-bottom-3 duration-500">
            <section>
              <SectionTitle icon={Fingerprint}>ç™»å…¥ ID ç‹€æ…‹</SectionTitle>
              <Card className="bg-slate-900 text-white border-none p-6 text-left shadow-2xl">
                <span className="text-[10px] font-bold opacity-40 uppercase tracking-[0.2em] mb-2 block">Active Session ID</span>
                <span className="text-lg font-black break-all leading-tight tracking-tight">{effectiveUserId || 'SYNCING...'}</span>
              </Card>
            </section>

            <Card className="space-y-5">
              <SectionTitle icon={CheckCircle}>åŒæ­¥é‡‘é‘°è¨­å®š</SectionTitle>
              <p className="text-xs text-slate-500 text-left -mt-2">åœ¨ä¸åŒè£ç½®è¼¸å…¥ç›¸åŒ IDï¼Œå³å¯åŒæ­¥ã€ŒæŒå€‰æ•¸é‡ã€é€±ç·šã€è²¸æ¬¾ã€çš„æ‰€æœ‰è¨˜æ†¶ã€‚</p>
              <input type="text" value={tempSyncId} onChange={(e) => setTempSyncId(e.target.value)} className="w-full bg-slate-50 dark:bg-slate-900 border-2 border-slate-100 dark:border-slate-700 rounded-2xl p-5 font-black text-lg focus:border-indigo-500 outline-none transition-all shadow-inner" placeholder="æ‚¨çš„å°ˆå±¬é‡‘é‘°" />
              <button onClick={applySyncId} className="w-full bg-indigo-600 text-white py-5 rounded-2xl font-black text-lg shadow-xl shadow-indigo-100 active:scale-95 transition-all">å¥—ç”¨ ID ä¸¦æ¢å¾©é›²ç«¯è¨˜æ†¶</button>
            </Card>

            {/* ç™½çš®æ›¸ä¿®æ­£ï¼šå®Œæ•´å…§å®¹ç„¡åˆ‡æ–· */}
            <section>
              <SectionTitle icon={BookOpen}>ç­–ç•¥ç™½çš®æ›¸ (å®Œæ•´ç‰ˆ)</SectionTitle>
              <Card className="p-0 overflow-hidden border-2 border-slate-100 dark:border-slate-700 shadow-sm text-left">
                <button onClick={() => setIsWhitepaperOpen(!isWhitepaperOpen)} className="w-full flex items-center justify-between p-5 bg-slate-50/50 dark:bg-slate-900/50 text-slate-700 dark:text-slate-300 font-black">
                  <div className="flex items-center gap-2"><Target size={18} /><span>æŸ¥é–±é€²å ´ã€é–åˆ©èˆ‡åŠ ç¢¼è¦å‰‡</span></div>
                  {isWhitepaperOpen ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
                </button>
                {isWhitepaperOpen && (
                  <div className="p-6 text-[13px] space-y-5 leading-relaxed bg-white dark:bg-slate-800 border-t dark:border-slate-700 animate-in slide-in-from-top-2 duration-300">
                    <div>
                      <p className="text-emerald-600 font-black flex items-center gap-2 mb-2"><ArrowRightCircle size={14} /> æ ¸å¿ƒé€²å ´æ¢ä»¶</p>
                      <ul className="pl-4 space-y-2 text-slate-600 dark:text-slate-400">
                        <li>â€¢ **å›æ­¸å¤šé ­ï¼š** æ”¶ç›¤åƒ¹ç«™å›é€±ç·š 25EMA ä¸”æ¼²å¹…é” 3%ã€‚</li>
                        <li>â€¢ **å¡åº¦è½‰å¼·ï¼š** EMA 5 å‘ä¸Šç©¿é EMA 12 â¡ å‡ç´š 2x QLDã€‚</li>
                        <li>â€¢ **ç‹™æ“Šé€²å ´ï¼š** å¤šé ­å›æ¸¬æ³¢æ®µé«˜é» &gt; 8% â¡ åˆ‡æ› 3x TQQQã€‚</li>
                      </ul>
                    </div>
                    <div>
                      <p className="text-amber-600 font-black flex items-center gap-2 mb-2"><Landmark size={14} /> è²¸æ¬¾åŠ ç¢¼è¦å‰‡</p>
                      <p className="pl-4 text-slate-600 dark:text-slate-400">
                        è‚¡åƒ¹å¿…é ˆ **å…ˆè·Œç ´é€±ç·š 25EMA**ï¼Œéš¨å¾Œå†æ¬¡ **æ¼²å›ç«™ç©© 25EMA** ä¸”å¡åº¦è½‰æ­£ (5 &gt; 12) æ™‚ï¼Œæ–¹å¯å•Ÿå‹•è²¸æ¬¾åŠ ç¢¼è³‡é‡‘ã€‚
                      </p>
                    </div>
                    <div>
                      <p className="text-red-600 font-black flex items-center gap-2 mb-2"><ShieldAlert size={14} /> æ’¤é€€èˆ‡ç”Ÿå­˜</p>
                      <ul className="pl-4 space-y-2 text-slate-600 dark:text-slate-400">
                        <li>â€¢ **ç”Ÿæ­»ç·šï¼š** æ¯æ—¥æ”¶ç›¤ç ´ 25EMA ä¹‹ 97% â¡ å¼·åˆ¶ 100% ç¾é‡‘ã€‚</li>
                        <li>â€¢ **é–åˆ©ï¼š** TQQQ é”æ¨™é«˜é» 98% æˆ–è·Œç ´ 5EMA â¡ æ›å› QLDã€‚</li>
                        <li>â€¢ **é‚„æ¬¾ï¼š** è²¸æ¬¾ç²åˆ©é”é è¨­ç›®æ¨™ (%) â¡ å„ªå…ˆå…¨é¡é‚„æ¬¾ã€‚</li>
                      </ul>
                    </div>
                  </div>
                )}
              </Card>
            </section>
          </div>
        )}

        {view === 'dashboard' && (
          <div className="space-y-6 animate-in fade-in">
            {/* æ¿€å‹µèªéŒ„ */}
            <section>
              <Card className="bg-indigo-50/40 dark:bg-indigo-900/10 border-indigo-100/50 dark:border-indigo-900/50 p-4 border-dashed">
                <div className="flex items-start gap-3">
                  <Quote size={22} className="text-indigo-400 mt-1 rotate-180 flex-shrink-0" />
                  <textarea 
                    rows="2"
                    placeholder="è¼¸å…¥ä¸€æ®µè©±æ¿€å‹µè‡ªå·±..."
                    value={inputs.motto}
                    onChange={(e) => handleInputChange('motto', e.target.value)}
                    onBlur={(e) => syncToCloud('motto', e.target.value)}
                    className="w-full bg-transparent border-none focus:ring-0 p-0 text-[15px] font-bold text-slate-700 dark:text-indigo-200 italic placeholder:text-slate-300 outline-none resize-none leading-relaxed"
                  />
                </div>
              </Card>
            </section>

            {/* è³‡ç”¢ç¸½è¦½ */}
            <section>
              <SectionTitle icon={Wallet}>å¸³æˆ¶è³‡ç”¢ç¸½è¦½</SectionTitle>
              <Card className="bg-gradient-to-br from-slate-900 via-indigo-950 to-indigo-900 text-white border-none shadow-2xl p-7 relative overflow-hidden">
                <div className="absolute right-0 bottom-0 p-4 opacity-5 rotate-12"><Fingerprint size={160} /></div>
                <div className="space-y-2 text-left relative z-10">
                  <label className="text-[11px] font-black opacity-50 uppercase tracking-[0.2em] block">Real-time Valuation</label>
                  <div className="flex items-baseline gap-3 flex-wrap">
                    <div className="text-4xl font-black tracking-tighter">${calculatedTotalCapital.toLocaleString(undefined, { minimumFractionDigits: 2 })}</div>
                    {inputs.loan_amount > 0 && <div className="text-xs font-black text-amber-400 bg-amber-400/20 px-3 py-1 rounded-full border border-amber-400/30">L: ${inputs.loan_amount.toLocaleString()}</div>}
                  </div>
                  <div className="text-[12px] opacity-40 font-bold tracking-widest mt-4 uppercase flex items-center gap-2">
                    <CheckCircle size={14} /> æ·¨è³‡ç”¢: ${(calculatedTotalCapital - inputs.loan_amount).toLocaleString()}
                  </div>
                </div>
              </Card>
            </section>

            {/* æŒå€‰è¨­å®š */}
            <section>
              <SectionTitle icon={PieChart}>æŒå€‰è¨­å®š (è‡ªå‹•åŒæ­¥è¨˜æ†¶)</SectionTitle>
              <Card className="grid grid-cols-2 gap-4">
                {[{ l: "QQQ", f: "qty_qqq", s: "QQQ" }, { l: "QLD", f: "qty_qld", s: "QLD" }, { l: "TQQQ", f: "qty_tqqq", s: "TQQQ" }, { l: "IBIT", f: "qty_ibit", s: "IBIT" }].map(it => (
                  <div key={it.f} className="space-y-1 text-left">
                    <div className="flex justify-between items-center px-1"><label className="text-[11px] font-black text-slate-400 uppercase">{it.l}</label><span className="text-[10px] font-black text-indigo-500 bg-indigo-50 dark:bg-indigo-900/30 px-2 py-0.5 rounded">${prices[it.s]?.toFixed(2)}</span></div>
                    <input type="number" inputMode="decimal" value={inputs[it.f]} onChange={(e) => handleInputChange(it.f, e.target.value)} onBlur={(e) => syncToCloud(it.f, e.target.value)} className="w-full bg-slate-50 dark:bg-slate-900 border-2 border-slate-50 dark:border-slate-700 rounded-2xl p-4 font-black text-lg focus:border-indigo-500 outline-none transition-all" />
                  </div>
                ))}
                <div className="col-span-2 space-y-1 text-left">
                  <label className="text-[11px] font-black text-slate-400 uppercase px-1">ç¾é‡‘é¤˜é¡ (USD)</label>
                  <input type="number" inputMode="decimal" value={inputs.cash_balance} onChange={(e) => handleInputChange('cash_balance', e.target.value)} onBlur={(e) => syncToCloud('cash_balance', e.target.value)} className="w-full bg-slate-50 dark:bg-slate-900 border-2 border-indigo-100/50 dark:border-indigo-900/50 rounded-2xl p-4 font-black text-xl text-indigo-600 outline-none text-center shadow-inner" />
                </div>
              </Card>
            </section>

            {/* é€±ç·šæ•¸æ“š */}
            <section>
              <SectionTitle icon={Calculator}>ç­–ç•¥é€±ç·šè¼¸å…¥</SectionTitle>
              <Card className="grid grid-cols-2 gap-4">
                {[{ l: "EMA 5", f: "qqq_ema5" }, { l: "EMA 12", f: "qqq_ema12" }, { l: "EMA 25", f: "qqq_ema25" }, { l: "æ­·å²é«˜é»", f: "qqq_ath" }].map(it => (
                  <div key={it.f} className="space-y-1 text-left">
                    <label className="text-[11px] font-black text-slate-400 uppercase px-1">{it.l}</label>
                    <input type="number" inputMode="decimal" value={inputs[it.f]} onChange={(e) => handleInputChange(it.f, e.target.value)} onBlur={(e) => syncToCloud(it.f, e.target.value)} className="w-full bg-slate-50 dark:bg-slate-900 border-2 border-slate-50 dark:border-slate-700 rounded-2xl p-4 font-black text-lg outline-none" />
                  </div>
                ))}
              </Card>
            </section>

            {/* æˆ°ç•¥åˆ†æå»ºè­° */}
            <section>
              <SectionTitle icon={ShieldAlert}>æˆ°ç•¥åˆ†æå»ºè­° (ç´”éƒ¨ä½è¨Šè™Ÿ)</SectionTitle>
              <Card className={`border-l-[12px] transition-all duration-500 shadow-lg ${analysis?.alertLevel === 'error' ? 'border-l-red-500 bg-red-50 dark:bg-red-950/20' : analysis?.alertLevel === 'success' ? 'border-l-green-500 bg-green-50 dark:bg-green-950/20' : 'border-l-indigo-500 bg-indigo-50 dark:bg-indigo-900/20'}`}>
                <div className="flex items-start gap-4 text-left">
                  <div className={`p-4 rounded-3xl ${analysis?.alertLevel === 'error' ? 'bg-red-100 text-red-600' : analysis?.alertLevel === 'success' ? 'bg-green-100 text-green-600' : 'bg-indigo-100 text-indigo-600'}`}><ShieldAlert size={36} /></div>
                  <div className="space-y-2">
                    <p className="text-2xl font-black leading-tight tracking-tighter">{analysis?.coreRecommendation}</p>
                    <p className="text-[15px] font-bold opacity-80 leading-relaxed">{analysis?.reason}</p>
                  </div>
                </div>
              </Card>
            </section>

            <section>
              <SectionTitle icon={Calendar}>ç´€éŒ„å­˜æª”æ—¥æœŸ</SectionTitle>
              <Card className="p-2 shadow-inner"><input type="date" value={inputs.record_date} onChange={(e) => handleInputChange('record_date', e.target.value)} className="w-full bg-slate-50 dark:bg-slate-900 rounded-2xl p-4 font-black text-xl text-center outline-none border-none" /></Card>
            </section>

            <button onClick={saveRecord} className="w-full bg-slate-900 dark:bg-indigo-600 text-white py-6 rounded-[2rem] font-black text-xl shadow-2xl active:scale-95 transition-all mb-12 flex items-center justify-center gap-3">
              <Save size={24} /> å„²å­˜ç´€éŒ„è‡³é›²ç«¯æ­·å²
            </button>
          </div>
        )}

        {view === 'loan' && (
          <div className="space-y-6 animate-in fade-in slide-in-from-right-3 duration-500 text-left">
            <section><SectionTitle icon={Landmark}>è²¸æ¬¾åŠ ç¢¼å°ˆå€</SectionTitle>
              <Card className="space-y-6 border-2 border-amber-100 dark:border-amber-900/30 shadow-xl">
                <div className="p-5 bg-amber-50 dark:bg-amber-900/20 rounded-3xl border border-amber-200 flex items-start gap-4 shadow-sm">
                  <Info size={28} className="text-amber-600 flex-shrink-0 mt-0.5" />
                  <p className="text-[14px] text-amber-800 dark:text-amber-300 leading-relaxed font-black">
                    åŠ ç¢¼å‰æï¼šè‚¡åƒ¹å¿…é ˆã€Œå…ˆè·Œç ´ 25EMAã€ï¼Œéš¨å¾Œå†æ¬¡ã€Œæ¼²å›ç«™ç©© 25EMAã€æ™‚æ–¹å¯å‹•ç”¨ã€‚
                  </p>
                </div>
                <div className="grid grid-cols-1 gap-6">
                  {[{ l: "è²¸æ¬¾ç¸½é¡ (USD)", f: "loan_amount" }, { l: "å¹´åŒ–åˆ©ç‡ (%)", f: "loan_rate" }, { l: "è²¸æ¬¾æœŸé™ (å¹´)", f: "loan_years" }, { l: "é‚„æ¬¾ç²åˆ©ç›®æ¨™ (%)", f: "loan_repay_target" }].map(it => (
                    <div key={it.f} className="space-y-2">
                      <label className="text-[11px] font-black text-amber-600 uppercase tracking-widest px-1">{it.l}</label>
                      <input type="number" inputMode="decimal" value={inputs[it.f]} onChange={(e) => handleInputChange(it.f, e.target.value)} onBlur={(e) => syncToCloud(it.f, e.target.value)} className="w-full bg-amber-50 dark:bg-slate-900 border-2 border-amber-100 dark:border-amber-800 rounded-[1.5rem] p-5 font-black text-xl focus:border-amber-500 outline-none transition-all shadow-inner" />
                    </div>
                  ))}
                </div>
                <div className="p-6 bg-amber-100/50 dark:bg-amber-900/30 rounded-3xl border-2 border-dashed border-amber-200">
                  <h4 className="text-sm font-black text-amber-800 dark:text-amber-300 mb-2 flex items-center gap-2"><CreditCard size={18}/> å„Ÿé‚„é è­¦é–€æª»</h4>
                  <p className="text-[14px] text-amber-700 dark:text-amber-400 font-bold leading-relaxed">
                    ç•¶è³‡ç”¢å ±é…¬é” **{inputs.loan_repay_target}%** (${(calculatedTotalCapital * (1 + inputs.loan_repay_target/100)).toLocaleString()}) æ™‚ï¼Œå¼·çƒˆå»ºè­°å…¨é¡å„ªå…ˆé‚„æ¸…è²¸æ¬¾ã€‚
                  </p>
                </div>
              </Card>
            </section>
          </div>
        )}

        {view === 'history' && (
          <div className="space-y-6 animate-in fade-in duration-500">
            <h2 className="text-2xl font-black px-1 flex items-center gap-2 text-indigo-600 text-left"><BarChart3 size={24} />è³‡ç”¢ç¸¾æ•ˆåˆ†æ</h2>
            <div className="flex gap-2 p-1.5 bg-slate-200 dark:bg-slate-800 rounded-2xl shadow-inner">
              {['all', 'year', 'month'].map(m => (
                <button key={m} onClick={() => setFilterMode(m)} className={`flex-1 py-4 rounded-xl text-xs font-black uppercase transition-all ${filterMode === m ? 'bg-white dark:bg-slate-700 shadow-md text-indigo-600 scale-[1.02]' : 'text-slate-500'}`}>{m === 'all' ? 'å…¨éƒ¨' : m === 'year' ? 'å¹´åº¦' : 'æœ¬æœˆ'}</button>
              ))}
            </div>
            
            <Card className="grid grid-cols-2 gap-4 py-8 text-center bg-white dark:bg-slate-800 border-none shadow-xl">
              <div className="border-r dark:border-slate-700"><span className="text-[10px] font-black text-slate-400 block mb-2 uppercase tracking-[0.2em]">å€é–“å ±é…¬ç‡</span><span className={`text-3xl font-black ${stats.growth >= 0 ? 'text-emerald-500' : 'text-red-500'}`}>{stats.growth >= 0 ? '+' : ''}{stats.growth.toFixed(2)}%</span></div>
              <div><span className="text-[10px] font-black text-slate-400 block mb-2 uppercase tracking-[0.2em]">å€é–“çµ‚å€¼</span><span className="text-2xl font-black text-slate-800 dark:text-slate-200 tracking-tighter">${stats.end.toLocaleString()}</span></div>
            </Card>

            <Card className="h-80 p-2 bg-white dark:bg-slate-800 shadow-xl border-none overflow-hidden">
              <ResponsiveContainer width="100%" height="100%">
                <AreaChart data={[...stats.filteredList].reverse()} margin={{ top: 15, right: 10, left: 0, bottom: 25 }}>
                  <defs><linearGradient id="colorEquity" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#6366f1" stopOpacity={0.4}/><stop offset="95%" stopColor="#6366f1" stopOpacity={0}/></linearGradient></defs>
                  <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                  <XAxis dataKey="date" tickFormatter={(v) => new Date(v).toLocaleDateString('zh-TW', { month: 'numeric', day: 'numeric' })} tick={{ fontSize: 10, fontWeight: '900', fill: '#94a3b8' }} minTickGap={35} dy={15} />
                  <YAxis tickFormatter={(v) => `$${(v/1000).toFixed(0)}k`} tick={{ fontSize: 10, fontWeight: '900', fill: '#94a3b8' }} width={50} />
                  <Tooltip labelFormatter={(v) => new Date(v).toLocaleDateString()} formatter={(val) => [`$${val.toLocaleString()}`, 'è³‡ç”¢åƒ¹å€¼']} />
                  <Area type="monotone" dataKey="total_equity" stroke="#6366f1" strokeWidth={5} fillOpacity={1} fill="url(#colorEquity)" dot={{ r: 4, fill: '#6366f1', strokeWidth: 2, stroke: '#fff' }} activeDot={{ r: 7, shadow: '0 0 10px rgba(99,102,241,0.5)' }} />
                </AreaChart>
              </ResponsiveContainer>
            </Card>
            
            <SectionTitle icon={History}>æ˜ç´°ç´€éŒ„æ¸…å–®</SectionTitle>
            <div className="space-y-4 pb-28 text-left">
              {stats.filteredList.map((rec) => (
                <Card key={rec.id} className="border-none shadow-md overflow-hidden p-5 bg-white dark:bg-slate-800/50">
                  {editingId === rec.id ? (
                    <div className="space-y-5 animate-in slide-in-from-top-1">
                      <div className="flex justify-between items-center border-b dark:border-slate-700 pb-3"><span className="text-sm font-black text-indigo-600 uppercase tracking-widest">ä¿®æ”¹æŒå€‰æ•¸é‡</span><button onClick={() => setEditingId(null)} className="p-1"><X size={24} /></button></div>
                      <div className="grid grid-cols-2 gap-4">
                        <div className="col-span-2 space-y-1"><label className="text-[11px] font-black text-slate-400">ç´€éŒ„æ—¥æœŸ</label><input type="date" value={editForm.date} onChange={(e) => setEditForm({...editForm, date: e.target.value})} className="w-full bg-slate-50 dark:bg-slate-900 border-2 rounded-2xl p-4 font-black outline-none" /></div>
                        {['qty_qqq', 'qty_qld', 'qty_tqqq', 'qty_ibit', 'cash_balance'].map(f => (
                          <div key={f} className="space-y-1"><label className="text-[11px] font-black text-slate-400 uppercase">{f.replace('qty_', '')}</label><input type="number" inputMode="decimal" value={editForm.inputs[f]} onChange={(e) => setEditForm({...editForm, inputs: {...editForm.inputs, [f]: e.target.value}})} className="w-full bg-slate-50 dark:bg-slate-900 border-2 rounded-2xl p-4 font-black outline-none" /></div>
                        ))}
                      </div>
                      <button onClick={() => updateRecord(rec.id)} className="w-full bg-indigo-600 text-white py-5 rounded-3xl font-black text-lg shadow-xl active:scale-95 transition-all">å„²å­˜ä¸¦é‡æ–°è¨ˆç®—ç¸½é¡</button>
                    </div>
                  ) : (
                    <>
                      <div className="flex justify-between items-start">
                        <div className="space-y-1">
                          <p className="text-[11px] font-black text-slate-400 uppercase tracking-widest">{new Date(rec.date).toLocaleDateString()}</p>
                          <p className="text-2xl font-black text-slate-800 dark:text-slate-100 tracking-tighter">${rec.total_equity?.toLocaleString()}</p>
                        </div>
                        <div className="flex gap-2 flex-wrap justify-end max-w-[130px]">
                          <div className="px-3 py-1 bg-indigo-50 dark:bg-indigo-900/40 text-indigo-600 dark:text-indigo-300 rounded-full text-[10px] font-black border border-indigo-100 dark:border-indigo-900/50">{rec.core_pos?.includes("TQQQ") ? "TQQQ" : rec.core_pos?.includes("QLD") ? "QLD" : "QQQ"}</div>
                          <div className="px-3 py-1 bg-orange-50 dark:bg-orange-900/40 text-orange-600 dark:text-orange-300 rounded-full text-[10px] font-black border border-orange-100 dark:border-orange-900/50">{rec.sat_pos}</div>
                        </div>
                      </div>
                      <div className="mt-6 flex justify-end gap-3 items-center">
                        {deletingId === rec.id ? (
                          <div className="flex gap-2 animate-in slide-in-from-right-2">
                            <span className="text-sm font-black text-red-500 my-auto pr-3">ç¢ºå®šåˆªé™¤ç´€éŒ„ï¼Ÿ</span>
                            <button onClick={() => confirmDelete(rec.id)} className="bg-red-500 text-white px-6 py-2.5 rounded-2xl text-sm font-black shadow-lg active:scale-90">æ˜¯</button>
                            <button onClick={() => setDeletingId(null)} className="bg-slate-200 dark:bg-slate-700 px-6 py-2.5 rounded-2xl text-sm font-black active:scale-90">å¦</button>
                          </div>
                        ) : (
                          <><button onClick={() => startEdit(rec)} className="text-slate-300 hover:text-indigo-500 p-3 rounded-full active:bg-slate-100 transition-all"><Edit2 size={22} /></button><button onClick={() => setDeletingId(rec.id)} className="text-slate-300 hover:text-red-500 p-3 rounded-full active:bg-slate-100 transition-all"><Trash2 size={22} /></button></>
                        )}
                      </div>
                    </>
                  )}
                </Card>
              ))}
              {stats.filteredList.length === 0 && <div className="text-center py-20 text-slate-300 font-black italic tracking-widest">NO RECORDS FOUND</div>}
            </div>
          </div>
        )}
      </main>

      {/* åº•éƒ¨å°è¦½åˆ— - æ‰‹æ©Ÿæ‹‡æŒ‡å€åŸŸå¼·åŒ– */}
      <nav className="fixed bottom-0 left-0 right-0 bg-white/90 dark:bg-slate-800/90 backdrop-blur-lg border-t dark:border-slate-700 px-4 py-4 pb-10 z-40 flex justify-around items-center shadow-[0_-10px_40px_rgba(0,0,0,0.06)]">
        <button onClick={() => setView('dashboard')} className={`flex flex-col items-center gap-2 flex-1 transition-all active:scale-90 ${view === 'dashboard' ? 'text-indigo-600 scale-110' : 'text-slate-400'}`}>
          <LayoutDashboard size={28} /><span className="text-[10px] font-black uppercase tracking-widest">å„€è¡¨æ¿</span>
        </button>
        <button onClick={() => setView('history')} className={`flex flex-col items-center gap-2 flex-1 transition-all active:scale-90 ${view === 'history' ? 'text-indigo-600 scale-110' : 'text-slate-400'}`}>
          <History size={28} /><span className="text-[10px] font-black uppercase tracking-widest">ç¸¾æ•ˆ</span>
        </button>
        <button onClick={() => setView('loan')} className={`flex flex-col items-center gap-2 flex-1 transition-all active:scale-90 ${view === 'loan' ? 'text-amber-600 scale-110' : 'text-slate-400'}`}>
          <Landmark size={28} /><span className="text-[10px] font-black uppercase tracking-widest">è²¸æ¬¾</span>
        </button>
      </nav>
    </div>
  );
};

export default App;
