<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="QQQ Control">
    <title>QQQ æˆ°ç•¥å„€è¡¨æ¿ v10.2 (Final Clean)</title>
    
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgdmlld0JveD0iMCAwIDUxMiA1MTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIiByeD0iMTAwIiBmaWxsPSIjMUUxQjRCIi8+CjxwYXRoIGQ9Ik0zNjAgMzYwTDI4MCAyODBNMzQwIDIyMEMzNDAgMjg2LjI3NCAyODYuMjc0IDM0MCAyMjAgMzQwQzE1My43MjYgMzQwIDEwMCAyODYuMjc0IDEwMCAyMjBDMTAwIDE1My43MjYgMTUzLjcyNiAxMDAgMjIwIDEwMEMyODYuMjc0IDEwMCAzNDAgMTUzLjcyNiAzNDAgMjIwWiIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSI0MCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+CjxwYXRoIGQ9Ik0xNjAgMzAwTDIyMCAyNDBMMjgwIDMwMEwzODAgMTgwIiBzdHJva2U9IiMxMEI5ODEiIHN0cm9rZS13aWR0aD0iMjQiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8L3N2Zz4=">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.10.0/umd/Recharts.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { indigo: { 950: '#1e1b4b' } } } }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .dark body { background-color: #0f172a; }
        .light body { background-color: #f1f5f9; }
        input, select, textarea { font-size: 14px !important; line-height: 1.4 !important; padding: 8px 4px !important; width: 100%; background-color: transparent; border: none; outline: none; text-align: center; }
        .strategy-textarea { text-align: left !important; padding: 12px !important; min-height: 100px; font-size: 13px !important; border-radius: 12px; background-color: rgba(255,255,255,0.5); border: 1px dashed #cbd5e1; transition: all 0.3s ease; }
        .dark .strategy-textarea { background-color: rgba(30, 41, 59, 0.5); border-color: #334155; color: #e2e8f0; }
        .strategy-read-only { border: 1px solid transparent !important; background-color: transparent !important; cursor: default; }
        .title-input { width: 100%; font-weight: 900; background: transparent; outline: none; text-align: left; padding: 0; transition: all 0.2s; }
        .title-input-edit { border-bottom: 2px solid #6366f1; padding-bottom: 4px; }
        .whitepaper-scroll { max-height: 60vh; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .tab-active { color: #4f46e5; border-top: 3px solid #4f46e5; }
        @keyframes pulse-dot { 0%, 100% { opacity: 0.6; transform: scale(0.9); } 50% { opacity: 1; transform: scale(1.1); } }
        .sync-loading { animation: pulse-dot 1.2s infinite ease-in-out; }
        .risk-alert-card { animation: pulse-border 2s infinite; }
        @keyframes pulse-border { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .alert-btn-pulse { animation: alert-pulse 1.5s infinite; }
        @keyframes alert-pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7); } 70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(255, 255, 255, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="light text-left font-black text-slate-900 dark:text-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;
        const { AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, PieChart, Pie, Cell, Legend } = Recharts;

        const appId = "qqq-strategic-production-v1"; 
        const FINNHUB_API_KEY = "d4q36b9r01qha6q0jclgd4q36b9r01qha6q0jcm0";
        const firebaseConfig = { apiKey: "AIzaSyBpax3wlTwHTe6G3niZajtTxpoUWbgvX80", authDomain: "qldmax.firebaseapp.com", projectId: "qldmax", storageBucket: "qldmax.firebasestorage.app", messagingSenderId: "752199866954", appId: "1:752199866954:web:50d17ae522095c363d64b3" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                TrendingUp: <path d="m22 7-8.5 8.5-5-5L2 17M22 7h-6M22 7v6"/>,
                Settings: <path d="M12.22 2h-.44a2 2 0 0 0-2 2a2 2 0 0 1-2 2a2 2 0 0 0-2 2a2 2 0 0 1-2 2a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2a2 2 0 0 1 2-2a2 2 0 0 0 2-2a2 2 0 0 1 2-2a2 2 0 0 0-2-2zM9 12a3 3 0 1 1 6 0a3 3 0 0 1-6 0z"/>,
                RefreshCcw: <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8m0 4a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16m-18-8h5V3m13 18h-5v5"/>,
                LayoutDashboard: <><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></>,
                History: <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8m0 0V3m0 5h5M12 7v5l4 2"/>,
                Landmark: <><line x1="3" x2="21" y1="22" y2="22"/><line x1="6" x2="6" y1="18" y2="11"/><line x1="10" x2="10" y1="18" y2="11"/><line x1="14" x2="14" y1="18" y2="11"/><line x1="18" x2="18" y1="18" y2="11"/><polygon points="12 2 20 11 4 11 12 2"/></>,
                Save: <><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></>,
                Quote: <path d="M3 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2H4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1 0 2.5 0 2-2 4-.5.5-.5 1 0 1.5zM16 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2h-2c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1 0 2.5 0 2-2 4-.5.5-.5 1 0 1.5z"/>,
                ShieldAlert: <><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></>,
                CheckCircle: <><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>,
                Edit2: <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>,
                Trash2: <><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>,
                X: <><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></>,
                BookOpen: <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2zM22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>,
                ChevronDown: <path d="m6 9 6 6 6-6"/>,
                ChevronUp: <path d="m18 15-6-6-6 6"/>,
                PieChartIcon: <><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></>,
                MessageSquare: <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>,
                Fingerprint: <><path d="M2 12C2 6.48 6.48 2 12 2s10 4.48 10 10"/><path d="M12 12v3"/><path d="M16 17.5c-2.5 1.5-5.5 1.5-8 0"/></>, 
                BarChart2: <path d="M18 20V10M12 20V4M6 20v-6"/>,
                Lock: <g><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></g>,
                Unlock: <g><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 9.9-1" /></g>,
                Calculator: <g><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></g>,
                AlertCircle: <g><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></g>
            };
            return <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>{icons[name] || <circle cx="12" cy="12" r="10" />}</svg>;
        };

        const Card = ({ children, className = "" }) => <div className={`rounded-[2rem] shadow-xl border p-5 transition-all bg-white dark:bg-slate-900 border-slate-200 dark:border-slate-800 ${className}`}>{children}</div>;
        const SectionTitle = ({ title, iconName }) => <h2 className="text-[11px] font-black mb-3 flex items-center gap-2 uppercase tracking-widest text-slate-500 dark:text-slate-400 font-black font-black"><Icon name={iconName} size={14} /> {title}</h2>;

        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('dashboard');
            const [records, setRecords] = useState([]);
            const [prices, setPrices] = useState({ QQQ: 0, QLD: 0, TQQQ: 0, IBIT: 0 });
            const [loadingPrices, setLoadingPrices] = useState(false);
            const [isSaving, setIsSaving] = useState(false);
            const [darkMode, setDarkMode] = useState(() => localStorage.getItem('qqq_theme') === 'dark');
            const [message, setMessage] = useState(null);
            const [editingId, setEditingId] = useState(null);
            const [editForm, setEditForm] = useState(null);
            const [deletingId, setDeletingId] = useState(null);
            const [filterMode, setFilterMode] = useState('all');
            const [visibleCount, setVisibleCount] = useState(20);
            const [isWhitepaperOpen, setIsWhitepaperOpen] = useState(false); 
            const [isStatsOpen, setStatsOpen] = useState(false);
            const [isStrategyEditing, setIsStrategyEditing] = useState(false); 
            const [simulatedTotal, setSimulatedTotal] = useState('');
            const [isCalcOpen, setIsCalcOpen] = useState(false); 
            const [isAlertsView, setIsAlertsView] = useState(false);

            const [customSyncId, setCustomSyncId] = useState(() => localStorage.getItem('qqq_sync_id') || '');
            const [tempSyncId, setTempSyncId] = useState(customSyncId);
            const effectiveUserId = customSyncId || (user ? user.uid : null);

            const [inputs, setInputs] = useState({
                qqq_ema5: 0, qqq_ema12: 0, qqq_ema25: 0, qqq_ath: 0, 
                ibit_ema50_wk: 0, custom_1_ema50_wk: 0, custom_2_ema50_wk: 0, 
                current_positions: 'CASH', qty_qqq: 0, qty_qld: 0, qty_tqqq: 0, qty_ibit: 0,
                custom_ticker_1: 'TSLA', qty_custom_1: 0, custom_ticker_2: 'GOOGL', qty_custom_2: 0,
                cash_balance: 0, record_date: new Date().toISOString().split('T')[0],
                loan_amount: 0, loan_rate: 2.0, loan_years: 7, loan_repay_target: 20, 
                loan_entry_valuation: 0, loan_monthly_repay: 0, motto: '', record_memo: '',
                alloc_core: 70, alloc_faith_1: 10, alloc_faith_2: 10, alloc_sat: 10,
                title_core: "æ ¸å¿ƒç­–ç•¥ (70%)", strat_core: "", title_qld: "æ§“æ¡¿å‹•æ…‹ (QLD/TQQQ)", strat_qld: "", title_faith: "ä¿¡ä»°æŒå€‰ (20%) - è‡ªé¸çµ„åˆ", strat_faith: "", title_ibit: "è¡›æ˜Ÿé…ç½® (10%) - IBIT", strat_ibit: ""
            });

            const showToast = (txt) => { setMessage(txt); setTimeout(() => setMessage(null), 3000); };
            const handleInputChange = (f, v) => setInputs(p => ({ ...p, [f]: v === '' ? '' : (isNaN(v) ? v : parseFloat(v)) }));
            const syncToCloud = async (f, v) => { if (!effectiveUserId) return; await db.collection('artifacts').doc(appId).collection('users').doc(effectiveUserId).collection('config').doc('current').set({ [f]: v }, { merge: true }); };

            const fetchPrices = useCallback(async () => {
                if (loadingPrices) return; setLoadingPrices(true);
                const t1 = (inputs.custom_ticker_1 || "").trim().toUpperCase(); const t2 = (inputs.custom_ticker_2 || "").trim().toUpperCase();
                const syms = [...new Set(['QQQ', 'QLD', 'TQQQ', 'IBIT', t1, t2].filter(Boolean))];
                try {
                    const results = await Promise.allSettled(syms.map(async (s) => {
                        const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=${s}&token=${FINNHUB_API_KEY}`);
                        const d = await res.json();
                        return { symbol: s, price: d.c || 0 };
                    }));
                    const newMap = {}; results.forEach(res => { if (res.status === 'fulfilled' && res.value.price > 0) newMap[res.value.symbol] = res.value.price; });
                    setPrices(prev => ({ ...prev, ...newMap }));
                } catch (e) {} finally { setLoadingPrices(false); }
            }, [inputs.custom_ticker_1, inputs.custom_ticker_2, loadingPrices]);

            const getNum = (val) => val === '' ? 0 : val;

            const periodicStats = useMemo(() => {
                if (records.length < 2) return { years: [], months: [] };
                const sorted = [...records].sort((a, b) => new Date(a.date) - new Date(b.date));
                const yearsMap = {}; const monthsMap = {};
                sorted.forEach(r => {
                    const d = new Date(r.date); const y = d.getFullYear(); const m = `${y}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                    if (!yearsMap[y]) yearsMap[y] = { first: r, last: r }; else yearsMap[y].last = r;
                    if (!monthsMap[m]) monthsMap[m] = { first: r, last: r }; else monthsMap[m].last = r;
                });
                const calc = (map) => Object.entries(map).map(([key, val]) => {
                    const start = val.first.total_equity || 0; const end = val.last.total_equity || 0; const diff = end - start; const pct = start > 0 ? (diff / start) * 100 : 0;
                    return { label: key, start, end, diff, pct };
                }).sort((a, b) => b.label.localeCompare(a.label));
                return { years: calc(yearsMap), months: calc(monthsMap) };
            }, [records]);

            const stats = useMemo(() => {
                if (records.length < 1) return { growth: 0, end: 0, chartData: [] };
                const now = new Date();
                const filtered = records.filter(r => { const d = new Date(r.date); if (filterMode === 'year') return d.getFullYear() === now.getFullYear(); if (filterMode === 'month') return d.getFullYear() === now.getFullYear() && d.getMonth() === now.getMonth(); return true; });
                const sorted = [...filtered].sort((a,b) => new Date(a.date) - new Date(b.date));
                const st = sorted[0]?.total_equity || 0; const en = sorted[sorted.length-1]?.total_equity || 0;
                return { start: st, end: en, growth: st > 0 ? ((en - st) / st) * 100 : 0, chartData: sorted };
            }, [records, filterMode]);

            const totalCapital = useMemo(() => {
                const p = prices; const t1 = (inputs.custom_ticker_1 || "").toUpperCase(); const t2 = (inputs.custom_ticker_2 || "").toUpperCase();
                return ( (p.QQQ || 0) * (getNum(inputs.qty_qqq)) ) + ( (p.QLD || 0) * (getNum(inputs.qty_qld)) ) + ( (p.TQQQ || 0) * (getNum(inputs.qty_tqqq)) ) + ( (p.IBIT || 0) * (getNum(inputs.qty_ibit)) ) + ( (p[t1] || 0) * (getNum(inputs.qty_custom_1)) ) + ( (p[t2] || 0) * (getNum(inputs.qty_custom_2)) ) + ( getNum(inputs.cash_balance) );
            }, [prices, inputs]);

            const allocationBase = useMemo(() => simulatedTotal ? parseFloat(simulatedTotal) : totalCapital, [simulatedTotal, totalCapital]);
            const loanSellThreshold = useMemo(() => (getNum(inputs.loan_entry_valuation)) * (1 + (getNum(inputs.loan_repay_target)) / 100), [inputs.loan_entry_valuation, inputs.loan_repay_target]);
            const isTargetReached = totalCapital >= loanSellThreshold && inputs.loan_entry_valuation > 0;

            const pieData = useMemo(() => {
                const p = prices; const t1 = (inputs.custom_ticker_1 || "").toUpperCase(); const t2 = (inputs.custom_ticker_2 || "").toUpperCase();
                const d = [ { name: 'QQQ', value: (p.QQQ||0)*(getNum(inputs.qty_qqq)), color: '#4f46e5' }, { name: 'QLD', value: (p.QLD||0)*(getNum(inputs.qty_qld)), color: '#818cf8' }, { name: 'TQQQ', value: (p.TQQQ||0)*(getNum(inputs.qty_tqqq)), color: '#c084fc' }, { name: 'IBIT', value: (p.IBIT||0)*(getNum(inputs.qty_ibit)), color: '#f59e0b' }, { name: t1, value: (p[t1]||0)*(getNum(inputs.qty_custom_1)), color: '#10b981' }, { name: t2, value: (p[t2]||0)*(getNum(inputs.qty_custom_2)), color: '#06b6d4' }, { name: 'ç¾é‡‘', value: getNum(inputs.cash_balance), color: '#94a3b8' } ];
                const filtered = d.filter(x => x.value > 0); const sum = filtered.reduce((a, b) => a + b.value, 0);
                return filtered.map(x => ({ ...x, percentage: sum > 0 ? ((x.value / sum) * 100).toFixed(1) : 0 }));
            }, [prices, inputs]);

            const currentLeverage = useMemo(() => {
                if (totalCapital <= 0) return 0;
                const p = prices; const t1 = (inputs.custom_ticker_1 || "").toUpperCase(); const t2 = (inputs.custom_ticker_2 || "").toUpperCase();
                const val_tqqq = (p.TQQQ || 0) * getNum(inputs.qty_tqqq); const val_qld = (p.QLD || 0) * getNum(inputs.qty_qld); const val_qqq = (p.QQQ || 0) * getNum(inputs.qty_qqq);
                const val_others = ( (p.IBIT || 0) * getNum(inputs.qty_ibit) ) + ( (p[t1] || 0) * getNum(inputs.qty_custom_1) ) + ( (p[t2] || 0) * getNum(inputs.qty_custom_2) );
                const exposure = (val_tqqq * 3) + (val_qld * 2) + (val_qqq * 1) + (val_others * 1);
                return (exposure / totalCapital).toFixed(2);
            }, [totalCapital, prices, inputs]);

            const nonCoreLeverageContribution = useMemo(() => (getNum(inputs.alloc_faith_1) + getNum(inputs.alloc_faith_2) + getNum(inputs.alloc_sat)) / 100 * 1, [inputs.alloc_faith_1, inputs.alloc_faith_2, inputs.alloc_sat]);

            const strategyAlerts = useMemo(() => {
                const alerts = []; const p = prices; const i = inputs; const t1 = (i.custom_ticker_1 || "").toUpperCase(); const t2 = (i.custom_ticker_2 || "").toUpperCase();
                const ema25 = getNum(i.qqq_ema25); const ema5 = getNum(i.qqq_ema5); const ema12 = getNum(i.qqq_ema12); const ath = getNum(i.qqq_ath);
                if (ema25 > 0 && p.QQQ < (ema25 * 0.97)) alerts.push({ type: 'danger', title: 'ğŸ›‘ æ ¸å¿ƒéƒ¨ä½ï¼šå´©ç›¤é¿éšª', msg: `QQQ è·Œç ´é€±ç·š 25EMA $${ema25} (å«-3%ç·©è¡ $${(ema25*0.97).toFixed(2)})ï¼ç­–ç•¥å»ºè­°ï¼šæ ¸å¿ƒéƒ¨ä½å…¨æ•¸è½‰ç‚ºç¾é‡‘ (CASH) é¿éšªã€‚` });
                else if (ema5 > 0 && ema12 > 0 && ema5 > ema12 && p.QQQ > (ema25 * 1.03)) alerts.push({ type: 'opportunity', title: 'ğŸš€ æ ¸å¿ƒéƒ¨ä½ï¼šå·¡èˆªæ¨¡å¼ (QLD)', msg: `é€±ç·š 5>12 ä¸”ç«™ç©© 25EMA $${ema25} (å«+3%ç¢ºèª $${(ema25*1.03).toFixed(2)})ã€‚ç­–ç•¥å»ºè­°ï¼šæ ¸å¿ƒéƒ¨ä½åˆ‡æ›è‡³ 2x QLDã€‚` });
                if (ath > 0 && p.QQQ < (ath * 0.92) && p.QQQ > (ema25 * 1.03)) alerts.push({ type: 'sniper', title: 'ğŸ¯ æ ¸å¿ƒéƒ¨ä½ï¼šç‹™æ“Šæ©Ÿæœƒ (TQQQ)', msg: 'QQQ è·å‰é«˜å›æª”è¶…é 8% ä¸”è¶¨å‹¢æœªç ´ã€‚ç­–ç•¥å»ºè­°ï¼šå¯è¦–æƒ…æ³åˆ‡æ› 3x TQQQ é€²è¡ŒçŸ­ç·šç‹™æ“Šã€‚' });
                if (i.current_positions === 'TQQQ' && p.QQQ < (ema5 * 0.97) && ema5 > 0) alerts.push({ type: 'warning', title: 'ğŸ“‰ æ ¸å¿ƒéƒ¨ä½ï¼šæ”»æ“Šç†„ç«', msg: `QQQ æ”¶ç›¤è·Œç ´é€± 5EMA $${ema5} (å«-3%ç·©è¡ $${(ema5*0.97).toFixed(2)})ã€‚ç­–ç•¥å»ºè­°ï¼šTQQQ ç²åˆ©/åœæï¼Œé€€å®ˆ QLD æˆ– QQQã€‚` });
                const checkRisk = (ticker, price, ema) => { 
                    const e = getNum(ema);
                    if (ticker && price > 0 && e > 0) {
                        if (price < (e * 0.97)) alerts.push({ type: 'risk', title: `âš ï¸ è³£å‡ºè¨Šè™Ÿï¼š${ticker}`, msg: `${ticker} è·Œç ´é€±ç·š 50EMA ($${e}) ä¹‹ä¸‹æ–¹ 3% ç·©è¡ä½ ($${(e*0.97).toFixed(2)})ï¼Œå»ºè­°è³£å‡ºè½‰ SGOVã€‚` });
                        if (price > (e * 1.03)) alerts.push({ type: 'opportunity', title: `ğŸ”µ è²·é€²è¨Šè™Ÿï¼š${ticker}`, msg: `${ticker} çªç ´é€±ç·š 50EMA ($${e}) ä¹‹ä¸Šæ–¹ 3% ç·©è¡ä½ ($${(e*1.03).toFixed(2)})ï¼Œè¶¨å‹¢ç¿»å¤šï¼Œå»ºè­°è²·é€²ã€‚` });
                    }
                };
                checkRisk('IBIT', p.IBIT, i.ibit_ema50_wk); checkRisk(t1, p[t1], i.custom_1_ema50_wk); checkRisk(t2, p[t2], i.custom_2_ema50_wk);
                return alerts;
            }, [prices, inputs]);

            const copyToMemo = (msg) => { const newMemo = (inputs.record_memo || '') + '\n' + `[${new Date().toLocaleDateString()}] ${msg}`; setInputs(prev => ({ ...prev, record_memo: newMemo })); showToast("å·²å¯«å…¥å‚™è¨»"); };

            useEffect(() => { auth.signInAnonymously().catch(console.error); const unsub = auth.onAuthStateChanged(setUser); return () => unsub(); }, []);
            useEffect(() => { if (!effectiveUserId) return; const userPath = db.collection('artifacts').doc(appId).collection('users').doc(effectiveUserId); userPath.collection('trading_records').onSnapshot(snap => setRecords(snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => new Date(b.date) - new Date(a.date)))); userPath.collection('config').doc('current').onSnapshot(snap => { if (snap.exists) setInputs(prev => ({ ...prev, ...snap.data(), record_date: new Date().toISOString().split('T')[0] })); }); fetchPrices(); }, [effectiveUserId]);
            useEffect(() => { const root = window.document.documentElement; if (darkMode) root.classList.add('dark'); else root.classList.remove('dark'); }, [darkMode]);

            const save = async () => { if (!effectiveUserId || isSaving) return; setIsSaving(true); const d = new Date(inputs.record_date); d.setHours(12, 0, 0, 0); try { await db.collection('artifacts').doc(appId).collection('users').doc(effectiveUserId).collection('trading_records').add({ date: d.toISOString(), total_equity: totalCapital, core_pos: inputs.current_positions, prices: { ...prices }, inputs: { ...inputs }, memo: inputs.record_memo || '' }); await db.collection('artifacts').doc(appId).collection('users').doc(effectiveUserId).collection('config').doc('current').set(inputs, { merge: true }); showToast("åŒæ­¥æˆåŠŸï¼"); setInputs(p => ({ ...p, record_memo: '' })); } catch (e) { showToast("å„²å­˜å¤±æ•—"); } finally { setIsSaving(false); } };
            const confirmDelete = async (id) => { try { await db.collection('artifacts').doc(appId).collection('users').doc(effectiveUserId).collection('trading_records').doc(id).delete(); setDeletingId(null); showToast("å·²åˆªé™¤"); } catch (e) {} };
            const updateRecord = async (id) => { const d = new Date(editForm.date); d.setHours(12, 0, 0, 0); const hP = editForm.prices || prices; const hI = editForm.inputs; const t1 = (hI.custom_ticker_1 || "").toUpperCase(); const t2 = (hI.custom_ticker_2 || "").toUpperCase(); const nT = ( (hP.QQQ || 0) * (parseFloat(hI.qty_qqq) || 0) ) + ( (hP.QLD || 0) * (parseFloat(hI.qty_qld) || 0) ) + ( (hP.TQQQ || 0) * (parseFloat(hI.qty_tqqq) || 0) ) + ( (hP.IBIT || 0) * (parseFloat(hI.qty_ibit) || 0) ) + ( (hP[t1] || 0) * (parseFloat(hI.qty_custom_1) || 0) ) + ( (hP[t2] || 0) * (parseFloat(hI.qty_custom_2) || 0) ) + ( parseFloat(hI.cash_balance) || 0 ); await db.collection('artifacts').doc(appId).collection('users').doc(effectiveUserId).collection('trading_records').doc(id).update({ date: d.toISOString(), inputs: hI, total_equity: nT, memo: editForm.memo || '' }); setEditingId(null); showToast("ä¿®æ”¹å®Œæˆ"); };
            const getAlertColor = (type) => { switch(type) { case 'danger': return 'bg-red-500 border-red-700 text-white'; case 'risk': return 'bg-orange-500 border-orange-700 text-white'; case 'opportunity': return 'bg-blue-600 border-blue-800 text-white'; case 'sniper': return 'bg-purple-600 border-purple-800 text-white'; case 'warning': return 'bg-yellow-500 border-yellow-700 text-white'; default: return 'bg-slate-700 text-white'; } };

            return (
                <div className="pb-32 min-h-screen transition-colors duration-300 font-black text-left select-none overflow-x-hidden">
                    {message && <div className="fixed top-24 left-1/2 -translate-x-1/2 z-[60] animate-in fade-in slide-in-from-top-4 font-black"><div className="bg-indigo-600 text-white px-6 py-3 rounded-full shadow-2xl text-sm flex items-center gap-2"><Icon name="CheckCircle" size={16} /> {message}</div></div>}
                    <header className="fixed top-0 left-0 right-0 bg-indigo-900 dark:bg-slate-950 z-50 px-5 py-4 flex justify-between items-center shadow-lg text-white">
                        <div className="flex items-center gap-2 font-black"><div className="bg-white p-2 rounded-2xl shadow-sm"><Icon name="TrendingUp" className="text-indigo-900" size={18} /></div><h1 className="font-black text-lg">QQQ Control</h1></div>
                        <div className="flex items-center gap-2">
                             <button onClick={() => { setIsCalcOpen(!isCalcOpen); setIsWhitepaperOpen(false); }} className={`p-2.5 rounded-xl border-2 transition-all active:scale-90 shadow-sm ${isCalcOpen ? 'bg-indigo-600 border-indigo-600 text-white' : 'bg-white border-slate-100 text-slate-700'}`}><Icon name="Calculator" size={20} /></button>
                             <button onClick={() => { setIsWhitepaperOpen(!isWhitepaperOpen); setIsCalcOpen(false); }} className={`p-2.5 rounded-xl border-2 transition-all active:scale-90 shadow-sm ${isWhitepaperOpen ? 'bg-indigo-600 border-indigo-600 text-white' : 'bg-white border-slate-100 text-slate-700'}`}><Icon name="BookOpen" size={20} /></button>
                            <button onClick={() => setDarkMode(!darkMode)} className="p-2.5 rounded-xl bg-white/10 active:scale-90 font-black font-black"><Icon name={darkMode ? "Sun" : "Moon"} size={20} /></button>
                            <button onClick={() => setView('sync_settings')} className="p-2.5 rounded-xl bg-white border-2 border-slate-100 text-slate-700 active:scale-90 shadow-sm"><Icon name="Settings" size={20} /></button>
                            <div className="flex items-center gap-1.5 ml-1"><button onClick={fetchPrices} className="p-2 text-white/80 active:rotate-180 transition-transform font-black font-black"><Icon name="RefreshCcw" size={22} className={loadingPrices ? 'animate-spin' : ''} /></button><div className={`w-3.5 h-3.5 rounded-full border-2 ${loadingPrices ? 'bg-red-500 border-red-300 sync-loading' : 'bg-emerald-500 border-emerald-300 shadow-emerald-500/50'}`}></div></div>
                        </div>
                    </header>

                    <main className="max-w-md mx-auto p-4 pt-24 space-y-6">
                        {view === 'dashboard' && (
                            <div className="space-y-6 animate-in fade-in font-black">
                                {isCalcOpen && ( 
                                    <Card className="p-0 overflow-hidden border-4 border-indigo-400 bg-indigo-50 dark:bg-indigo-950 shadow-2xl text-left mb-6 animate-in slide-in-from-top-4 duration-300">
                                        <div className="p-4 bg-indigo-600 text-white flex justify-between items-center"><div className="flex items-center gap-2 font-black"><Icon name="Calculator" size={20} /><span>æˆ°ç•¥é…å€‰è¨ˆç®—æ©Ÿ</span></div><button onClick={() => setIsCalcOpen(false)}><Icon name="X" size={20} /></button></div>
                                        <div className="p-5 space-y-5">
                                            <div className="flex gap-2"><input type="number" placeholder="è¼¸å…¥é è¨ˆç¸½è³‡ç”¢ (USD)..." value={simulatedTotal} onChange={e => setSimulatedTotal(e.target.value)} className="flex-1 bg-white dark:bg-slate-800 border-2 border-indigo-200 rounded-xl px-4 py-3 text-lg font-black focus:border-indigo-500 outline-none" /><button onClick={() => setSimulatedTotal(totalCapital.toFixed(0))} className="bg-indigo-600 text-white px-4 rounded-xl font-bold text-xs whitespace-nowrap active:scale-95 transition-transform">å¸¶å…¥<br/>æ·¨å€¼</button></div>
                                            <div className="grid grid-cols-2 gap-2">
                                                <div className="space-y-1"><label className="text-[10px] text-indigo-500 font-bold uppercase">æ ¸å¿ƒ %</label><input type="number" value={inputs.alloc_core} onChange={e => handleInputChange('alloc_core', e.target.value)} onBlur={(e) => syncToCloud('alloc_core', e.target.value)} className="w-full bg-white dark:bg-slate-800 border border-indigo-200 rounded-lg p-2 text-center font-bold text-indigo-600" /></div>
                                                <div className="space-y-1"><label className="text-[10px] text-amber-500 font-bold uppercase">è¡›æ˜Ÿ %</label><input type="number" value={inputs.alloc_sat} onChange={e => handleInputChange('alloc_sat', e.target.value)} onBlur={(e) => syncToCloud('alloc_sat', e.target.value)} className="w-full bg-white dark:bg-slate-800 border border-amber-200 rounded-lg p-2 text-center font-bold text-amber-600" /></div>
                                                <div className="space-y-1"><label className="text-[10px] text-sky-500 font-bold uppercase truncate">{inputs.custom_ticker_1 || 'ä¿¡ä»°1'} %</label><input type="number" value={inputs.alloc_faith_1} onChange={e => handleInputChange('alloc_faith_1', e.target.value)} onBlur={(e) => syncToCloud('alloc_faith_1', e.target.value)} className="w-full bg-white dark:bg-slate-800 border border-sky-200 rounded-lg p-2 text-center font-bold text-sky-600" /></div>
                                                <div className="space-y-1"><label className="text-[10px] text-cyan-500 font-bold uppercase truncate">{inputs.custom_ticker_2 || 'ä¿¡ä»°2'} %</label><input type="number" value={inputs.alloc_faith_2} onChange={e => handleInputChange('alloc_faith_2', e.target.value)} onBlur={(e) => syncToCloud('alloc_faith_2', e.target.value)} className="w-full bg-white dark:bg-slate-800 border border-cyan-200 rounded-lg p-2 text-center font-bold text-cyan-600" /></div>
                                            </div>
                                            <div className="space-y-2 text-sm">
                                                <div className="bg-white dark:bg-slate-800 p-3 rounded-xl border-l-4 border-indigo-500 shadow-sm"><div className="flex justify-between items-center mb-1"><span className="text-indigo-600 font-bold">â— æ ¸å¿ƒéƒ¨ä½ (${(allocationBase * (getNum(inputs.alloc_core)/100)).toLocaleString(undefined, {maximumFractionDigits:0})})</span></div><div className="grid grid-cols-4 gap-1 text-[10px] text-center text-slate-400 font-mono mb-1"><div className="col-span-1">æ¨™çš„</div><div className="col-span-1">ç¾åƒ¹</div><div className="col-span-2">å»ºè­°è‚¡æ•¸</div></div><div className="space-y-1">{['QQQ', 'QLD', 'TQQQ'].map(tk => (<div key={tk} className="grid grid-cols-4 gap-1 text-xs text-center font-bold items-center"><div className="text-slate-600 dark:text-slate-300">{tk}</div><div className="text-slate-400">${prices[tk]?.toFixed(0)}</div><div className="col-span-2 flex justify-between items-center bg-slate-100 dark:bg-slate-700/50 rounded px-2 py-0.5"><span className="text-indigo-600 dark:text-indigo-300">{prices[tk] > 0 ? Math.floor((allocationBase * (getNum(inputs.alloc_core)/100)) / prices[tk]).toLocaleString() : '-'} è‚¡</span><span className="text-[9px] text-slate-400 ml-1">({(nonCoreLeverageContribution + (getNum(inputs.alloc_core) / 100 * (tk === 'QQQ' ? 1 : tk === 'QLD' ? 2 : 3))).toFixed(2)}x)</span></div></div>))}<div className="grid grid-cols-4 gap-1 text-xs text-center font-bold items-center border-t dark:border-slate-700 pt-1 mt-1"><div className="text-slate-500">ç¾é‡‘</div><div className="col-span-3 text-slate-400 text-right pr-2">ç©ºå€‰æŒæœ‰ ${ (allocationBase * (getNum(inputs.alloc_core)/100)).toLocaleString(undefined, {maximumFractionDigits:0}) }</div></div></div></div>
                                                <div className="bg-white dark:bg-slate-800 p-3 rounded-xl border-l-4 border-sky-500 shadow-sm"><div className="flex justify-between items-center mb-1"><span className="text-sky-600 font-bold">â— ä¿¡ä»°éƒ¨ä½ (${(allocationBase * ((getNum(inputs.alloc_faith_1) + getNum(inputs.alloc_faith_2))/100)).toLocaleString(undefined, {maximumFractionDigits:0})})</span></div><div className="space-y-1">{inputs.custom_ticker_1 && inputs.custom_ticker_1.trim() !== '' && (<div className="grid grid-cols-4 gap-1 text-xs text-center font-bold items-center"><div className="text-slate-600 dark:text-slate-300 truncate">{inputs.custom_ticker_1}</div><div className="text-slate-400">${prices[(inputs.custom_ticker_1||'').toUpperCase()]?.toFixed(0) || '-'}</div><div className="col-span-2 bg-slate-100 dark:bg-slate-700/50 rounded py-0.5 text-sky-600 dark:text-sky-300">{prices[(inputs.custom_ticker_1||'').toUpperCase()] > 0 ? Math.floor((allocationBase * (getNum(inputs.alloc_faith_1)/100)) / prices[(inputs.custom_ticker_1||'').toUpperCase()]).toLocaleString() : '-'} è‚¡ ({inputs.alloc_faith_1}%)</div></div>)}{inputs.custom_ticker_2 && inputs.custom_ticker_2.trim() !== '' && (<div className="grid grid-cols-4 gap-1 text-xs text-center font-bold items-center"><div className="text-slate-600 dark:text-slate-300 truncate">{inputs.custom_ticker_2}</div><div className="text-slate-400">${prices[(inputs.custom_ticker_2||'').toUpperCase()]?.toFixed(0) || '-'}</div><div className="col-span-2 bg-slate-100 dark:bg-slate-700/50 rounded py-0.5 text-cyan-600 dark:text-cyan-300">{prices[(inputs.custom_ticker_2||'').toUpperCase()] > 0 ? Math.floor((allocationBase * (inputs.alloc_faith_2/100)) / prices[(inputs.custom_ticker_2||'').toUpperCase()]).toLocaleString() : '-'} è‚¡ ({inputs.alloc_faith_2}%)</div></div>)}</div></div>
                                                <div className="bg-white dark:bg-slate-800 p-3 rounded-xl border-l-4 border-amber-500 shadow-sm"><div className="flex justify-between items-center mb-1"><span className="text-amber-500 font-bold">â— è¡›æ˜Ÿéƒ¨ä½ (${(allocationBase * (getNum(inputs.alloc_sat)/100)).toLocaleString(undefined, {maximumFractionDigits:0})})</span></div><div className="grid grid-cols-4 gap-1 text-xs text-center font-bold items-center"><div className="text-slate-600 dark:text-slate-300">IBIT</div><div className="text-slate-400">${prices.IBIT?.toFixed(0)}</div><div className="col-span-2 bg-slate-100 dark:bg-slate-700/50 rounded py-0.5 text-amber-600 dark:text-amber-300">{prices.IBIT > 0 ? Math.floor((allocationBase * (getNum(inputs.alloc_sat)/100)) / prices.IBIT).toLocaleString() : '-'} è‚¡</div></div></div>
                                            </div>
                                        </div>
                                    </Card>
                                )}

                                {isWhitepaperOpen && ( 
                                    <Card className="p-0 overflow-hidden border-4 border-indigo-400 bg-white dark:bg-slate-900 shadow-2xl text-left mb-6 animate-in slide-in-from-top-4 duration-300">
                                        <div className="p-4 bg-indigo-600 text-white flex justify-between items-center"><div className="flex items-center gap-2 font-black"><Icon name="BookOpen" size={20} /><span>ç­–ç•¥åŸ·è¡Œå”è­° (Strategy Whitepaper)</span></div><button onClick={() => setIsWhitepaperOpen(false)}><Icon name="X" size={20} /></button></div>
                                        <div className="whitepaper-scroll p-5 space-y-6 leading-relaxed bg-white dark:bg-slate-900 font-medium font-black">
                                            <div className="flex justify-end mb-4 border-b border-dashed border-slate-200 dark:border-slate-700 pb-2"><button onClick={() => setIsStrategyEditing(!isStrategyEditing)} className={`flex items-center gap-2 px-4 py-2 rounded-xl text-xs font-black transition-all ${isStrategyEditing ? 'bg-indigo-600 text-white shadow-lg scale-105' : 'bg-slate-100 text-slate-500 dark:bg-slate-800 dark:text-slate-400'}`}><Icon name={isStrategyEditing ? "Unlock" : "Lock"} size={14} /><span>{isStrategyEditing ? "ç·¨è¼¯ä¸­ (é»æ“Šé–å®š)" : "é–å®šä¸­ (é»æ“Šä¿®æ”¹)"}</span></button></div>
                                            <div className="space-y-2"><div className="flex items-center gap-2 text-indigo-600 dark:text-indigo-400 font-black"><Icon name="TrendingUp" size={16}/> <input type="text" value={inputs.title_core} readOnly={!isStrategyEditing} onChange={e => handleInputChange('title_core', e.target.value)} onBlur={e => syncToCloud('title_core', e.target.value)} className={`title-input ${isStrategyEditing ? 'title-input-edit cursor-text' : 'cursor-default pointer-events-none'}`} /></div><textarea value={inputs.strat_core} readOnly={!isStrategyEditing} onChange={e => handleInputChange('strat_core', e.target.value)} onBlur={e => syncToCloud('strat_core', e.target.value)} className={`w-full strategy-textarea resize-none ${!isStrategyEditing ? 'strategy-read-only' : ''}`} placeholder="è¼¸å…¥æ ¸å¿ƒ QQQ ç­–ç•¥..." /></div>
                                            <div className="space-y-2"><div className="flex items-center gap-2 text-purple-600 dark:text-purple-400 font-black"><Icon name="TrendingUp" size={16}/> <input type="text" value={inputs.title_qld} readOnly={!isStrategyEditing} onChange={e => handleInputChange('title_qld', e.target.value)} onBlur={e => syncToCloud('title_qld', e.target.value)} className={`title-input ${isStrategyEditing ? 'title-input-edit cursor-text' : 'cursor-default pointer-events-none'}`} /></div><textarea value={inputs.strat_qld} readOnly={!isStrategyEditing} onChange={e => handleInputChange('strat_qld', e.target.value)} onBlur={e => syncToCloud('strat_qld', e.target.value)} className={`w-full strategy-textarea resize-none ${!isStrategyEditing ? 'strategy-read-only' : ''}`} placeholder="è¼¸å…¥æ§“æ¡¿æ“ä½œç­–ç•¥..." /></div>
                                            <div className="space-y-2"><div className="flex items-center gap-2 text-sky-600 dark:text-sky-400 font-black"><Icon name="Quote" size={16}/> <input type="text" value={inputs.title_faith} readOnly={!isStrategyEditing} onChange={e => handleInputChange('title_faith', e.target.value)} onBlur={e => syncToCloud('title_faith', e.target.value)} className={`title-input ${isStrategyEditing ? 'title-input-edit cursor-text' : 'cursor-default pointer-events-none'}`} placeholder="è‡ªè¨‚ä¿¡ä»°æŒå€‰æ¨™é¡Œ" /></div><textarea value={inputs.strat_faith} readOnly={!isStrategyEditing} onChange={e => handleInputChange('strat_faith', e.target.value)} onBlur={e => syncToCloud('strat_faith', e.target.value)} className={`w-full strategy-textarea resize-none ${!isStrategyEditing ? 'strategy-read-only' : ''}`} placeholder="è¼¸å…¥å€‹è‚¡/ä¿¡ä»°æŒå€‰ç­–ç•¥..." /></div>
                                            <div className="space-y-2"><div className="flex items-center gap-2 text-amber-500 dark:text-amber-400 font-black"><Icon name="TrendingUp" size={16}/> <input type="text" value={inputs.title_ibit} readOnly={!isStrategyEditing} onChange={e => handleInputChange('title_ibit', e.target.value)} onBlur={e => syncToCloud('title_ibit', e.target.value)} className={`title-input ${isStrategyEditing ? 'title-input-edit cursor-text' : 'cursor-default pointer-events-none'}`} /></div><textarea value={inputs.strat_ibit} readOnly={!isStrategyEditing} onChange={e => handleInputChange('strat_ibit', e.target.value)} onBlur={e => syncToCloud('strat_ibit', e.target.value)} className={`w-full strategy-textarea resize-none ${!isStrategyEditing ? 'strategy-read-only' : ''}`} placeholder="è¼¸å…¥è¡›æ˜Ÿ/IBITæ“ä½œç­–ç•¥..." /></div>
                                        </div>
                                    </Card>
                                )}

                                <Card className="p-4 bg-gradient-to-r from-indigo-500 to-purple-600 text-white shadow-lg border-none relative overflow-hidden transition-all duration-300">
                                    <div className="flex justify-between items-start mb-2">
                                        <div className="flex items-center gap-2 opacity-80"><Icon name={isAlertsView ? "ShieldAlert" : "Quote"} size={16} className="text-white" /><span className="text-[10px] uppercase tracking-widest font-bold">{isAlertsView ? "ç­–ç•¥è­¦ç¤º (Alerts)" : "æŠ•è³‡åº§å³éŠ˜ (Motto)"}</span></div>
                                        <button onClick={() => setIsAlertsView(!isAlertsView)} className={`p-1.5 rounded-full bg-white/20 hover:bg-white/30 transition-all ${strategyAlerts.length > 0 ? 'alert-btn-pulse bg-red-500/80 hover:bg-red-500' : ''}`}><Icon name="AlertCircle" size={18} className="text-white" /></button>
                                    </div>
                                    {isAlertsView ? (
                                        <div className="space-y-2 min-h-[60px] animate-in fade-in slide-in-from-right-4">
                                            {strategyAlerts.length > 0 ? (strategyAlerts.map((alert, idx) => (<div key={idx} className="bg-white/10 p-2 rounded-lg border border-white/20 backdrop-blur-sm"><div className="font-bold text-sm mb-1 flex items-center gap-1">{alert.type === 'danger' && 'ğŸ”´'}{alert.type === 'risk' && 'ğŸŸ '}{alert.type === 'opportunity' && 'ğŸ”µ'}{alert.type === 'sniper' && 'ğŸŸ£'}{alert.type === 'warning' && 'ğŸŸ¡'}{alert.title}</div><div className="text-xs opacity-90 leading-snug mb-2">{alert.msg}</div><button onClick={() => copyToMemo(alert.msg)} className="flex items-center gap-1 bg-white/20 hover:bg-white/30 px-2 py-0.5 rounded text-[9px] transition-colors ml-auto w-fit"><Icon name="Save" size={10} /> å­˜å…¥å‚™è¨»</button></div>))) : (<div className="flex flex-col items-center justify-center h-full py-4 opacity-70"><Icon name="CheckCircle" size={32} className="mb-1" /><span className="text-xs">ç›®å‰ç„¡è§¸ç™¼è­¦ç¤ºï¼Œç­–ç•¥é‹è¡Œæ­£å¸¸ã€‚</span></div>)}
                                        </div>
                                    ) : (
                                        <textarea value={inputs.motto} onChange={e => handleInputChange('motto', e.target.value)} onBlur={e => syncToCloud('motto', e.target.value)} className="w-full bg-transparent text-lg font-black text-center placeholder-white/50 outline-none resize-none animate-in fade-in slide-in-from-left-4" rows="2" placeholder="åœ¨æ­¤è¼¸å…¥æ‚¨çš„æŠ•è³‡å¿ƒæ³•..." />
                                    )}
                                </Card>

                                <div className="grid grid-cols-2 gap-3 text-center">
                                    <Card className="py-4 px-1 flex flex-col items-center justify-center min-h-[85px] font-black"><span className="text-[10px] text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-1">æ‰‹æŒéƒ¨ä½</span><select value={inputs.current_positions} onChange={e => { handleInputChange('current_positions', e.target.value); syncToCloud('current_positions', e.target.value); }} className="font-black text-center dark:text-white cursor-pointer py-1 text-[13px] h-auto"><option value="CASH">ğŸ’° ç¾é‡‘</option><option value="QQQ">ğŸ“ˆ 1x QQQ</option><option value="QLD">ğŸš€ 2x QLD</option><option value="TQQQ">ğŸ”¥ 3x TQQQ</option></select></Card>
                                    <Card className="py-4 px-1 flex flex-col items-center justify-center min-h-[85px] font-black"><span className="text-[10px] text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-1">ç´€éŒ„æ—¥æœŸ</span><input type="date" value={inputs.record_date} onChange={e => handleInputChange('record_date', e.target.value)} className="font-black dark:text-white py-1 text-[13px] h-auto font-black" /></Card>
                                </div>

                                <Card className="bg-gradient-to-br from-slate-900 via-indigo-950 to-indigo-900 text-white border-none shadow-2xl p-7 relative overflow-hidden text-left font-black">
                                    <div className="absolute -right-4 -bottom-4 opacity-10 rotate-12 font-black font-black"><Icon name="TrendingUp" size={160} /></div>
                                    <label className="text-[10px] opacity-50 uppercase tracking-widest block mb-1">Portfolio Valuation</label>
                                    <div className="flex items-baseline gap-3 flex-wrap font-black"><div className="text-4xl font-black">${totalCapital.toLocaleString(undefined, { minimumFractionDigits: 2 })}</div>{inputs.loan_amount > 0 && <div className="text-xs font-black text-amber-400 bg-amber-400/20 px-3 py-1 rounded-full border border-amber-400/30">L: ${inputs.loan_amount.toLocaleString()}</div>}</div>
                                    <div className="text-[12px] opacity-30 mt-5 uppercase flex items-center gap-2 font-black font-black font-black"><Icon name="CheckCircle" size={14} /> æ·¨è³‡ç”¢: ${(totalCapital - inputs.loan_amount).toLocaleString()}</div>
                                </Card>

                                <Card className="p-4 overflow-hidden text-center relative font-black font-black">
                                    <div className="flex justify-between items-center mb-2"><SectionTitle title="è³‡ç”¢åˆ†é…åœ“é¤…åœ–" iconName="PieChartIcon" /><span className="text-xs bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-200 px-2 py-1 rounded-lg font-bold">æ§“æ¡¿: {currentLeverage}x</span></div>
                                    <div className="h-64 w-full mt-2 font-black"><ResponsiveContainer width="100%" height="100%"><PieChart><Pie data={pieData} cx="50%" cy="50%" innerRadius={50} outerRadius={75} paddingAngle={4} dataKey="value" label={({ percentage }) => `${percentage}%`}>{pieData.map((entry, index) => <Cell key={`cell-${index}`} fill={entry.color} stroke="none" />)}</Pie><Tooltip formatter={(v) => `$${v.toLocaleString()}`} /><Legend verticalAlign="bottom" align="center" iconType="circle" /></PieChart></ResponsiveContainer></div>
                                </Card>

                                <Card className="space-y-4 text-left font-black font-black border-2 border-indigo-500 dark:border-indigo-600 shadow-[0_0_20px_rgba(79,70,229,0.2)]">
                                    <SectionTitle title="æŒå€‰æ•¸é‡è¼¸å…¥ (Input Holdings)" iconName="Edit2" />
                                    <div className="grid grid-cols-2 gap-4">
                                        {[{ l: "QQQ", f: "qty_qqq", s: "QQQ" }, { l: "QLD", f: "qty_qld", s: "QLD" }, { l: "TQQQ", f: "qty_tqqq", s: "TQQQ" }, { l: "IBIT", f: "qty_ibit", s: "IBIT" }].map(it => (<div key={it.f} className="space-y-1"><div className="flex justify-between items-center px-1 font-black"><label className="text-[11px] text-slate-400 uppercase font-black">{it.l}</label><span className="text-[10px] text-indigo-600 dark:text-indigo-400 bg-indigo-50 dark:bg-indigo-900/40 px-2 py-0.5 rounded font-mono tracking-tighter">${prices[it.s]?.toFixed(2) || '0.00'}</span></div><input type="number" value={inputs[it.f]} onChange={e => handleInputChange(it.f, e.target.value)} onBlur={(e) => syncToCloud(it.f, e.target.value)} className="w-full bg-slate-50 dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 rounded-2xl p-4 font-black text-lg text-center" /></div>))}
                                        <div className="space-y-1 text-left"><div className="flex justify-between items-center px-1 font-black"><input type="text" value={inputs.custom_ticker_1} onChange={e => handleInputChange('custom_ticker_1', e.target.value.toUpperCase())} onBlur={(e) => syncToCloud('custom_ticker_1', e.target.value.toUpperCase())} className="text-[11px] text-slate-400 bg-transparent p-0 w-16 outline-none text-left" /><span className="text-[10px] text-indigo-600 dark:text-indigo-400 bg-indigo-50 dark:bg-indigo-900/40 px-2 py-0.5 rounded font-mono tracking-tighter">${prices[(inputs.custom_ticker_1 || "").trim().toUpperCase()]?.toFixed(2) || '0.00'}</span></div><input type="number" value={inputs.qty_custom_1} onChange={e => handleInputChange('qty_custom_1', e.target.value)} onBlur={(e) => syncToCloud('qty_custom_1', e.target.value)} className="w-full bg-slate-50 dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 rounded-2xl p-4 font-black text-lg text-center font-black" /></div>
                                        <div className="space-y-1 text-left"><div className="flex justify-between items-center px-1 font-black"><input type="text" value={inputs.custom_ticker_2} onChange={e => handleInputChange('custom_ticker_2', e.target.value.toUpperCase())} onBlur={(e) => syncToCloud('custom_ticker_2', e.target.value.toUpperCase())} className="text-[11px] text-slate-400 bg-transparent p-0 w-16 outline-none text-left" /><span className="text-[10px] text-indigo-600 dark:text-indigo-400 bg-indigo-50 dark:bg-indigo-900/40 px-2 py-0.5 rounded font-mono tracking-tighter">${prices[(inputs.custom_ticker_2 || "").trim().toUpperCase()]?.toFixed(2) || '0.00'}</span></div><input type="number" value={inputs.qty_custom_2} onChange={e => handleInputChange('qty_custom_2', e.target.value)} onBlur={(e) => syncToCloud('qty_custom_2', e.target.value)} className="w-full bg-slate-50 dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 rounded-2xl p-4 font-black text-lg text-center font-black" /></div>
                                        <div className="col-span-2 space-y-1 text-center font-black font-black"><label className="text-[11px] font-black text-slate-500 px-1 uppercase block text-center w-full font-black">ç¾é‡‘é¤˜é¡ (USD)</label><input type="number" value={inputs.cash_balance} onChange={e => handleInputChange('cash_balance', e.target.value)} onBlur={(e) => syncToCloud('cash_balance', e.target.value)} className="w-full bg-slate-50 dark:bg-slate-800 border-2 border-indigo-100/50 dark:border-indigo-900/50 rounded-2xl p-4 font-black text-xl text-indigo-600" /></div>
                                    </div>
                                </Card>

                                <Card className="space-y-4">
                                    <SectionTitle title="æŠ€è¡“æŒ‡æ¨™åƒæ•¸ (QQQé€±ç·š/å…¶ä»–)" iconName="Settings" />
                                    <div className="grid grid-cols-3 gap-3">
                                        {[{ l: "EMA 5 (é€±)", f: "qqq_ema5" }, { l: "EMA 12 (é€±)", f: "qqq_ema12" }, { l: "EMA 25 (é€±)", f: "qqq_ema25" }].map(it => (<div key={it.f} className="space-y-1"><label className="text-[10px] text-slate-400 uppercase block text-center">{it.l}</label><input type="number" value={inputs[it.f]} onChange={e => handleInputChange(it.f, e.target.value)} onBlur={e => syncToCloud(it.f, e.target.value)} className="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl p-2.5 font-black text-center" /></div>))}
                                    </div>
                                    <div className="grid grid-cols-2 gap-3 pt-2 border-t border-slate-100 dark:border-slate-800">
                                         <div className="space-y-1"><label className="text-[10px] text-slate-400 uppercase block text-center">QQQ å‰é«˜ (ATH)</label><input type="number" value={inputs.qqq_ath} onChange={e => handleInputChange('qqq_ath', e.target.value)} onBlur={e => syncToCloud('qqq_ath', e.target.value)} className="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl p-2.5 font-black text-center" /></div>
                                        <div className="space-y-1"><label className="text-[10px] text-amber-500 uppercase block text-center">IBIT EMA 50 (é€±)</label><input type="number" value={inputs.ibit_ema50_wk} onChange={e => handleInputChange('ibit_ema50_wk', e.target.value)} onBlur={e => syncToCloud('ibit_ema50_wk', e.target.value)} className="w-full bg-amber-50 dark:bg-slate-800 border border-amber-100 dark:border-amber-900 rounded-xl p-2.5 font-black text-center" /></div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3 pt-2 border-t border-slate-100 dark:border-slate-800">
                                        <div className="space-y-1"><label className="text-[10px] text-sky-500 uppercase block text-center truncate">{inputs.custom_ticker_1 || 'è‡ªé¸1'} EMA 50 (é€±)</label><input type="number" value={inputs.custom_1_ema50_wk} onChange={e => handleInputChange('custom_1_ema50_wk', e.target.value)} onBlur={e => syncToCloud('custom_1_ema50_wk', e.target.value)} className="w-full bg-sky-50 dark:bg-slate-800 border border-sky-100 dark:border-sky-900/50 rounded-xl p-2.5 font-black text-center" /></div>
                                        <div className="space-y-1"><label className="text-[10px] text-sky-500 uppercase block text-center truncate">{inputs.custom_ticker_2 || 'è‡ªé¸2'} EMA 50 (é€±)</label><input type="number" value={inputs.custom_2_ema50_wk} onChange={e => handleInputChange('custom_2_ema50_wk', e.target.value)} onBlur={e => syncToCloud('custom_2_ema50_wk', e.target.value)} className="w-full bg-sky-50 dark:bg-slate-800 border border-sky-100 dark:border-sky-900/50 rounded-xl p-2.5 font-black text-center" /></div>
                                    </div>
                                </Card>

                                <Card className="p-4 space-y-2 border-dashed border-2 border-slate-300 text-left font-black"><SectionTitle title="æ±ºç­–ç´€éŒ„å‚™è¨»" iconName="MessageSquare" /><textarea rows="3" placeholder="åœ¨æ­¤è¼¸å…¥æœ¬æ¬¡æ±ºç­–å¿ƒå¾—..." value={inputs.record_memo} onChange={e => setInputs(p => ({ ...p, record_memo: e.target.value }))} className="bg-slate-50 dark:bg-slate-800 rounded-2xl p-4 text-[14px] font-medium resize-none text-left" /></Card>

                                <button onClick={save} disabled={isSaving} className={`w-full ${isSaving ? 'bg-slate-400' : 'bg-slate-900 dark:bg-indigo-600'} text-white py-6 rounded-[2rem] font-black text-xl shadow-2xl active:scale-95 mb-12 flex items-center justify-center gap-3 font-black font-black`}><Icon name={isSaving ? "RefreshCcw" : "Save"} size={24} className={isSaving ? "animate-spin" : ""} /> {isSaving ? "æ­£åœ¨åŒæ­¥..." : "å„²å­˜ç›®å‰ç´€éŒ„"}</button>
                            </div>
                        )}
                        
                        {/* History View */}
                        {view === 'history' && (
                            <div className="space-y-6 animate-in fade-in text-left">
                                <div className="flex gap-2 p-1.5 bg-slate-200 dark:bg-slate-800 rounded-3xl shadow-inner text-left font-black font-black font-black">
                                    {['all', 'year', 'month'].map(m => (
                                        <button key={m} onClick={() => setFilterMode(m)} className={`flex-1 py-4 rounded-2xl text-xs font-black uppercase transition-all ${filterMode === m ? 'bg-white shadow text-indigo-600 scale-[1.02]' : 'text-slate-500 font-black font-black'}`}>{m === 'all' ? 'å…¨éƒ¨' : m === 'year' ? 'å¹´åº¦' : 'æœ¬æœˆ'}</button>
                                    ))}
                                </div>
                                <Card className="h-72 p-2 shadow-xl border-none overflow-hidden bg-white dark:bg-slate-900 font-black font-black">
                                    <SectionTitle title="è³‡ç”¢æˆé•·è¶¨å‹¢" iconName="TrendingUp" />
                                    <ResponsiveContainer width="100%" height="100%" key={filterMode + stats.chartData.length}>
                                        <AreaChart data={stats.chartData} margin={{ top: 10, right: 10, left: -20, bottom: 20 }}>
                                            <defs><linearGradient id="colorEq" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#6366f1" stopOpacity={0.3}/><stop offset="95%" stopColor="#6366f1" stopOpacity={0}/></linearGradient></defs>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke={darkMode ? "#1e293b" : "#e2e8f0"} />
                                            <XAxis dataKey="date" tickFormatter={v => new Date(v).toLocaleDateString('zh-TW', { month: 'numeric', day: 'numeric' })} tick={{ fontSize: 10, fontWeight: '900', fill: darkMode ? '#64748b' : '#94a3b8' }} />
                                            <YAxis tickFormatter={v => `$${(v/1000).toFixed(0)}k`} tick={{ fontSize: 10, fontWeight: '900', fill: darkMode ? '#64748b' : '#94a3b8' }} />
                                            <Tooltip labelFormatter={v => new Date(v).toLocaleDateString()} />
                                            <Area type="monotone" dataKey="total_equity" stroke="#6366f1" strokeWidth={4} fillOpacity={1} fill="url(#colorEq)" dot={{ r: 3, fill: '#6366f1' }} />
                                        </AreaChart>
                                    </ResponsiveContainer>
                                </Card>
                                <Card className="p-0 overflow-hidden border-2 border-indigo-100 dark:border-indigo-900/40 shadow-sm text-left font-black font-black">
                                    <button onClick={() => setStatsOpen(!isStatsOpen)} className="w-full flex items-center justify-between p-5 bg-indigo-50 dark:bg-indigo-950/40 font-black text-indigo-700 dark:text-indigo-300">
                                        <div className="flex items-center gap-2"><Icon name="BarChart2" size={18} /><span>é€±æœŸæˆé•·çµ±è¨ˆ (å¹´åº¦/æœˆåº¦)</span></div>
                                        <Icon name={isStatsOpen ? "ChevronUp" : "ChevronDown"} size={20} />
                                    </button>
                                    {isStatsOpen && (
                                        <div className="p-5 space-y-6 max-h-[400px] overflow-y-auto no-scrollbar font-black text-[12px] bg-white dark:bg-slate-900 font-black">
                                            <div>
                                                <p className="text-[10px] text-slate-400 uppercase tracking-widest mb-3 border-b pb-1 dark:border-slate-800 font-black">â— å¹´åº¦çµç®— (å¹´åˆ vs å¹´æœ«)</p>
                                                <div className="space-y-2 font-black font-black font-black">
                                                    {periodicStats.years.map(y => (
                                                        <div key={y.label} className="flex justify-between items-center bg-slate-50 dark:bg-slate-800/50 p-3 rounded-2xl">
                                                            <span>{y.label} å¹´</span>
                                                            <div className="text-right font-black font-black">
                                                                <p className={`text-sm ${y.diff >= 0 ? 'text-emerald-500' : 'text-red-500'}`}>{y.diff >= 0 ? '+' : ''}${y.diff.toLocaleString(undefined, { maximumFractionDigits: 0 })}</p>
                                                                <p className={`text-[10px] ${y.diff >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{y.pct.toFixed(2)}%</p>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                            <div>
                                                <p className="text-[10px] text-slate-400 uppercase tracking-widest mb-3 border-b pb-1 dark:border-slate-800 font-black">â— æœˆåº¦æˆé•· (æœˆåˆ vs æœˆæœ«)</p>
                                                <div className="grid grid-cols-1 gap-2 font-black">
                                                    {periodicStats.months.map(m => (
                                                        <div key={m.label} className="flex justify-between items-center p-2.5 border-b dark:border-slate-800 font-black">
                                                            <span>{m.label}</span>
                                                            <span className={`font-mono ${m.diff >= 0 ? 'text-emerald-500' : 'text-red-500'}`}>{m.diff >= 0 ? '+' : ''}{m.pct.toFixed(1)}%</span>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </Card>
                                <div className="space-y-4 pb-28 font-black text-left font-black">
                                    {records.filter(r => { const d = new Date(r.date); const now = new Date(); if (filterMode === 'year') return d.getFullYear() === now.getFullYear(); if (filterMode === 'month') return d.getFullYear() === now.getFullYear() && d.getMonth() === now.getMonth(); return true; }).slice(0, visibleCount).map(rec => (
                                        <Card key={rec.id} className="border-none shadow-md p-5 bg-white dark:bg-slate-800/50 text-left font-black font-black font-black">
                                            {editingId === rec.id ? (
                                                <div className="space-y-5 animate-in slide-in-from-top-1 text-left font-black font-black font-black font-black">
                                                    <div className="flex justify-between items-center border-b dark:border-slate-700 pb-3 text-indigo-600 font-black font-black font-black"><span className="text-sm uppercase tracking-widest text-left font-black">ä¿®æ”¹æ­·å²æ•¸æ“š</span><button onClick={() => setEditingId(null)} className="p-1"><Icon name="X" size={24} /></button></div>
                                                    <div className="grid grid-cols-2 gap-4 text-left font-black">
                                                        <div className="col-span-2 space-y-1"><label className="text-[11px] font-black text-slate-400 uppercase">æ—¥æœŸ</label><input type="date" value={editForm.date} onChange={e => setEditForm({...editForm, date: e.target.value})} className="w-full bg-slate-50 dark:bg-slate-800 border-2 rounded-2xl p-4 font-black outline-none font-black" /></div>
                                                        {['qty_qqq', 'qty_qld', 'qty_tqqq', 'qty_ibit'].map(f => (<div key={f} className="space-y-1 font-black"><label className="text-[11px] font-black text-slate-400 uppercase text-left">{f.replace('qty_', '').toUpperCase()} æ•¸é‡</label><input type="number" value={editForm.inputs[f] || 0} onChange={e => setEditForm({...editForm, inputs: {...editForm.inputs, [f]: e.target.value}})} className="w-full bg-slate-50 dark:bg-slate-800 border-2 rounded-2xl p-4 font-black outline-none font-black" /></div>))}
                                                        <div className="space-y-1 font-black"><label className="text-[11px] font-black text-slate-400 uppercase font-black">{editForm.inputs.custom_ticker_1 || 'è‡ªé¸1'} æ•¸é‡</label><input type="number" value={editForm.inputs.qty_custom_1} onChange={e => setEditForm({...editForm, inputs: {...editForm.inputs, qty_custom_1: e.target.value}})} className="w-full bg-slate-50 dark:bg-slate-800 border-2 rounded-2xl p-4 font-black outline-none font-black font-black" /></div>
                                                        <div className="space-y-1 font-black"><label className="text-[11px] font-black text-slate-400 uppercase font-black">{editForm.inputs.custom_ticker_2 || 'è‡ªé¸2'} æ•¸é‡</label><input type="number" value={editForm.inputs.qty_custom_2} onChange={e => setEditForm({...editForm, inputs: {...editForm.inputs, qty_custom_2: e.target.value}})} className="w-full bg-slate-50 dark:bg-slate-800 border-2 rounded-2xl p-4 font-black outline-none font-black font-black" /></div>
                                                        <div className="col-span-2 space-y-1 font-black"><label className="text-[11px] font-black text-slate-400 uppercase text-left font-black">ç¾é‡‘é¤˜é¡</label><input type="number" value={editForm.inputs.cash_balance} onChange={e => setEditForm({...editForm, inputs: {...editForm.inputs, cash_balance: e.target.value}})} className="w-full bg-slate-50 dark:bg-slate-800 border-2 rounded-2xl p-4 font-black outline-none font-black" /></div>
                                                        <div className="col-span-2 space-y-1 text-left font-black font-black font-black"><label className="text-[11px] font-black text-slate-400 tracking-widest uppercase font-black font-black">ä¿®æ”¹å‚™è¨»</label><textarea value={editForm.memo} onChange={e => setEditForm({...editForm, memo: e.target.value})} className="w-full bg-slate-50 dark:bg-slate-800 border-2 rounded-2xl p-4 font-black outline-none text-left" rows="2" /></div>
                                                    </div>
                                                    <button onClick={() => updateRecord(rec.id)} className="w-full bg-indigo-600 text-white py-5 rounded-3xl font-black text-lg shadow-xl btn-active font-bold text-center font-black">ä¿å­˜é‡ç®—</button>
                                                </div>
                                            ) : (
                                                <>
                                                    <div className="flex justify-between items-start font-black text-left font-black font-black font-black">
                                                        <div className="space-y-1 font-black"><p className="text-[11px] font-black text-slate-400 uppercase tracking-widest">{new Date(rec.date).toLocaleDateString()}</p><p className="text-2xl font-black text-slate-800 dark:text-slate-100 tracking-tighter">${rec.total_equity?.toLocaleString()}</p></div>
                                                        <div className="px-3 py-1 bg-indigo-50 dark:bg-indigo-900 text-indigo-600 dark:text-indigo-300 rounded-full text-[10px] border border-indigo-100 font-black">{rec.core_pos || "CASH"}</div>
                                                    </div>
                                                    <div className="mt-2 grid grid-cols-4 gap-1 text-[9px] text-slate-400 border-t pt-2 dark:border-slate-800 font-black">
                                                        <span>QQQ:${rec.prices?.QQQ?.toFixed(1)}</span><span>IBIT:${rec.prices?.IBIT?.toFixed(1)}</span>
                                                        <span>{rec.inputs?.custom_ticker_1 || 'T1'}:${rec.prices?.[rec.inputs?.custom_ticker_1]?.toFixed(1) || '0'}</span>
                                                        <span>{rec.inputs?.custom_ticker_2 || 'T2'}:${rec.prices?.[rec.inputs?.custom_ticker_2]?.toFixed(1) || '0'}</span>
                                                    </div>
                                                    {rec.memo && <div className="mt-3 p-3 bg-slate-50 dark:bg-slate-800/80 rounded-xl border-l-4 border-indigo-200 text-left font-black"><p className="text-[12px] italic text-slate-600 dark:text-slate-300 font-black">ã€Œ {rec.memo} ã€</p></div>}
                                                    <div className="mt-6 flex justify-end gap-3 items-center">
                                                        {deletingId === rec.id ? (
                                                            <div className="flex gap-2 animate-in slide-in-from-right-2 text-left font-black font-black"><button onClick={() => confirmDelete(rec.id)} className="bg-red-500 text-white px-6 py-2 rounded-xl text-xs font-black">æ˜¯</button><button onClick={() => setDeletingId(null)} className="bg-slate-200 dark:bg-slate-700 px-6 py-2 rounded-xl text-xs font-black">å¦</button></div>
                                                        ) : (
                                                            <div className="flex gap-3"><button onClick={() => { setEditingId(rec.id); setEditForm({ ...rec, date: rec.date.split('T')[0], inputs: rec.inputs || { ...inputs } }); }} className="text-slate-300 hover:text-indigo-600 p-3 rounded-full bg-slate-50 dark:bg-slate-800 border border-slate-100 shadow-sm font-black"><Icon name="Edit2" size={20} /></button><button onClick={() => setDeletingId(rec.id)} className="text-slate-300 hover:text-red-600 p-3 rounded-full bg-slate-50 dark:bg-slate-800 border border-slate-100 shadow-sm"><Icon name="Trash2" size={20} /></button></div>
                                                        )}
                                                    </div>
                                                </>
                                            )}
                                        </Card>
                                    ))}
                                </div>
                            </div>
                        )}

                        {view === 'loan' && (
                            <div className="space-y-6 animate-in fade-in text-left font-black">
                                <Card className="space-y-6 border-2 border-amber-100 dark:border-amber-900/30 shadow-xl p-6 text-left font-black font-black font-black">
                                    <div className="p-5 bg-amber-50 dark:bg-amber-900/20 rounded-3xl flex items-start gap-4 border border-amber-100 font-medium font-black font-black font-black"><Icon name="Landmark" size={28} className="text-amber-600 flex-shrink-0" /><p className="text-[14px] text-amber-800 dark:text-amber-300 leading-relaxed font-black">é‚„æ¬¾é‚è¼¯ï¼šä»¥ã€Œè²·å…¥å¸‚å€¼ã€ç‚ºå›ºå®šåŸºæº–ï¼Œç²åˆ©é”æ¨™å»ºè­°æ’¤é€€ã€‚</p></div>
                                    <div className="grid grid-cols-1 gap-6 font-black font-black font-black">{[{ l: "è²¸æ¬¾è²·å…¥æ™‚å¸‚å€¼ (USDåŸºæº–)", f: "loan_entry_valuation" }, { l: "è²¸æ¬¾ç¸½é¡ (USD)", f: "loan_amount" }, { l: "æ¯æœˆé‚„æ¬¾é‡‘é¡ (USD)", f: "loan_monthly_repay" }, { l: "å¹´åŒ–åˆ©ç‡ (%)", f: "loan_rate" }, { l: "é‚„æ¬¾ç²åˆ©ç›®æ¨™ (%)", f: "loan_repay_target" }].map(it => (
                                        <div key={it.f} className="space-y-2 text-left text-amber-900 dark:text-amber-500 font-black font-black"><label className="text-[11px] uppercase tracking-widest px-1 text-amber-600">{it.l}</label><input type="number" value={inputs[it.f]} onChange={e => handleInputChange(it.f, e.target.value)} onBlur={(e) => syncToCloud(it.f, e.target.value)} className="w-full bg-amber-50 dark:bg-slate-800 border-2 border-amber-100 dark:border-amber-900 rounded-[1.5rem] p-5 font-black text-xl text-center" /></div>
                                    ))}</div>
                                    <Card className={`${isTargetReached ? 'repay-alert' : 'bg-amber-900 dark:bg-amber-950'} text-white border-none p-6 text-center shadow-lg transition-colors duration-500 font-black`}>
                                        <h4 className="text-xs opacity-60 uppercase mb-1 tracking-widest text-center font-black">è³£å‡ºé‚„æ¬¾é–€æª» (ä¾åŸºæº–å¸‚å€¼)</h4>
                                        <p className="text-xl font-mono tracking-tight text-center font-black font-black font-black">${ loanSellThreshold.toLocaleString(undefined, { maximumFractionDigits: 0 }) }</p>
                                    </Card>
                                </Card>
                            </div>
                        )}

                        {view === 'sync_settings' && (
                            <div className="space-y-6 animate-in fade-in text-left">
                                <Card className="bg-slate-800 text-white p-6 shadow-2xl relative overflow-hidden font-black font-black font-black"><div className="absolute right-0 top-0 p-4 opacity-10 font-black"><Icon name="Fingerprint" size={100} /></div><SectionTitle title="ç›®å‰åŒæ­¥é‡‘é‘° ID" iconName="Fingerprint" /><span className="text-lg font-black font-mono uppercase font-black">{effectiveUserId || 'æ­£åœ¨é€£çµ...'}</span></Card>
                                <Card className="space-y-4 font-black"><SectionTitle title="åˆ‡æ›åŒæ­¥ ID" iconName="CheckCircle" /><input type="text" value={tempSyncId} onChange={e => setTempSyncId(e.target.value)} className="w-full bg-slate-50 dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-800 rounded-2xl p-5 font-black text-lg focus:border-indigo-500" placeholder="è¼¸å…¥ ID" /><button onClick={() => { setCustomSyncId(tempSyncId.trim()); localStorage.setItem('qqq_sync_id', tempSyncId.trim()); setView('dashboard'); }} className="w-full bg-indigo-600 text-white py-5 rounded-2xl font-black text-lg shadow-xl active:scale-95 font-bold uppercase tracking-widest font-black">å¥—ç”¨åŒæ­¥</button></Card>
                            </div>
                        )}
                    </main>

                    <nav className="fixed bottom-0 left-0 right-0 bg-white dark:bg-slate-950 border-t border-slate-200 dark:border-slate-800 z-50 px-2 py-4 pb-10 flex justify-around items-center shadow-[0_-10px_30px_rgba(0,0,0,0.08)] safe-pb font-black text-left font-black font-black">
                        <button onClick={() => { setView('dashboard'); setVisibleCount(20); }} className={`flex flex-col items-center gap-2 flex-1 transition-all active:scale-90 ${view === 'dashboard' ? 'tab-active' : 'text-slate-400 font-black font-black'}`}><Icon name="LayoutDashboard" size={28} /><span className="text-[10px] font-black uppercase tracking-widest text-center">å„€è¡¨æ¿</span></button>
                        <button onClick={() => setView('history')} className={`flex flex-col items-center gap-2 flex-1 transition-all active:scale-90 ${view === 'history' ? 'tab-active' : 'text-slate-400'}`}><Icon name="History" size={28} /><span className="text-[10px] font-black uppercase tracking-widest text-center">ç¸¾æ•ˆ</span></button>
                        <button onClick={() => setView('loan')} className={`flex flex-col items-center gap-2 flex-1 transition-all active:scale-90 ${view === 'loan' ? 'text-amber-600' : 'text-slate-400 font-black'}`}><Icon name="Landmark" size={28} /><span className="text-[10px] font-black uppercase tracking-widest text-amber-600 text-center font-black font-black">è²¸æ¬¾</span></button>
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

