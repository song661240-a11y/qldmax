<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QQQ-IBIT æˆ°ç•¥å„€è¡¨æ¿</title>
    
    <!-- 1. æ¨£å¼ -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React æ ¸å¿ƒ -->
    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- 3. ç·¨è­¯èˆ‡åœ–è¡¨ -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.0/umd/Recharts.js"></script>

    <!-- 4. Firebase SDK (Compat å…¨åŸŸæ¨¡å¼) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { 
            font-family: 'Inter', -apple-system, system-ui, sans-serif;
            -webkit-tap-highlight-color: transparent;
            background-color: #f8fafc;
        }
        input, select, textarea { font-size: 16px !important; }
        .whitepaper-content { max-height: 60vh; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom, 24px); }
        .active-tab { color: #4f46e5; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;
        const { AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } = Recharts;

        // --- æ‰‹å‹• SVG åœ–ç¤ºè·¯å¾‘ (ç¢ºä¿ 100% ç©©å®šï¼Œä¸ä¾è³´ lucide-react åº«è¼‰å…¥) ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const paths = {
                TrendingUp: "M22 7l-8.5 8.5-5-5L2 17M22 7h-6M22 7v6",
                Settings: "M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z",
                RefreshCcw: "M1 4v6h6M23 20v-6h-6M20.49 9A9 9 0 0 0 5.64 5.64L1 10M22.99 14l-4.64 4.36A9 9 0 0 1 3.51 15",
                LayoutDashboard: "M3 3h7v9H3zm11 0h7v5h-7zm0 9h7v9h-7zm-11 11h7v-7H3z",
                History: "M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8M3 3v5h5M12 7v5l4 2",
                Landmark: "M3 22h18M6 18v-7M10 18v-7M14 18v-7M18 18v-7M12 2l10 5H2l10-5z",
                Save: "M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z M17 21v-8H7v8 M7 3v5h8",
                Trash2: "M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M10 11v6M14 11v6",
                PieChart: "M21.21 15.89A10 10 0 1 1 8 2.83M22 12A10 10 0 0 0 12 2v10z",
                ChevronDown: "M6 9l6 6 6-6",
                ChevronUp: "M18 15l-6-6-6 6",
                BookOpen: "M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z",
                Fingerprint: "M2 12a10 10 0 0 1 18-6M2 12c0 5.22 4.05 9.5 9 9.98V17M7 12a5 5 0 0 1 5-5M7 12c0 2.5 1.75 4.5 4 4.9V14M11 12a1 1 0 1 0 2 0 1 1 0 0 0-2 0",
                CheckCircle: "M22 11.08V12a10 10 0 1 1-5.93-9.14 M22 4L12 14.01l-3-3",
                Info: "M12 16v-4M12 8h.01M22 12A10 10 0 1 1 2 12a10 10 0 0 1 20 0z",
                Quote: "M3 21c3 0 7-1 7-8V5H2v8h5c0 2-2 3-5 4v4zm10 0c3 0 7-1 7-8V5h-8v8h5c0 2-2 3-5 4v4z",
                ShieldAlert: "M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z M12 8v4M12 16h.01",
                X: "M18 6L6 18M6 6l12 12",
                Edit2: "M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z",
                Calendar: "M19 4H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z M16 2v4M8 2v4M3 10h18",
                Target: "M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20z M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z",
                ArrowRightCircle: "M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20z M12 16l4-4-4-4M8 12h8"
            };
            return (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    <path d={paths[name] || ""} />
                </svg>
            );
        };

        // --- Firebase è¨­å®š ---
        const firebaseConfig = {
            apiKey: "AIzaSyBpax3wlTwHTe6G3niZajtTxpoUWbgvX80",
            authDomain: "qldmax.firebaseapp.com",
            projectId: "qldmax",
            storageBucket: "qldmax.firebasestorage.app",
            messagingSenderId: "752199866954",
            appId: "1:752199866954:web:50d17ae522095c363d64b3"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = "qqq-v24-final-stable-github";
        const FINNHUB_API_KEY = "d4q36b9r01qha6q0jclgd4q36b9r01qha6q0jcm0";

        // --- UI çµ„ä»¶ ---
        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-[2.2rem] shadow-sm border border-slate-100 p-5 ${className}`}>{children}</div>
        );

        const SectionTitle = ({ title, icon }) => (
            <h2 className="text-[11px] font-black text-slate-400 mb-3 flex items-center gap-2 uppercase tracking-[0.2em] px-1">
                <Icon name={icon} size={14} /> {title}
            </h2>
        );

        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('dashboard');
            const [prices, setPrices] = useState({ QQQ: 0, QLD: 0, TQQQ: 0, IBIT: 0 });
            const [loadingPrices, setLoadingPrices] = useState(false);
            const [isWhitepaperOpen, setWhitepaperOpen] = useState(false);
            
            const [filterMode, setFilterMode] = useState('all');
            const [deletingId, setDeletingId] = useState(null);
            const [editingId, setEditingId] = useState(null);
            const [editForm, setEditForm] = useState(null);

            const [customSyncId, setCustomSyncId] = useState(() => localStorage.getItem('qqq_sync_id') || '');
            const [tempSyncId, setTempSyncId] = useState(customSyncId);
            const effectiveUserId = customSyncId || (user ? user.uid : null);

            const [inputs, setInputs] = useState({
                qqq_ema5: 0, qqq_ema12: 0, qqq_ema25: 0, qqq_ath: 0, ibit_ema50: 0,
                current_positions: 'CASH', qty_qqq: 0, qty_qld: 0, qty_tqqq: 0, qty_ibit: 0,
                cash_balance: 0, record_date: new Date().toISOString().split('T')[0],
                loan_amount: 0, loan_rate: 2.0, loan_years: 7, loan_repay_target: 20, motto: ''
            });

            const [records, setRecords] = useState([]);

            const totalCapital = useMemo(() => {
                return (prices.QQQ * (parseFloat(inputs.qty_qqq) || 0)) + 
                       (prices.QLD * (parseFloat(inputs.qty_qld) || 0)) + 
                       (prices.TQQQ * (parseFloat(inputs.qty_tqqq) || 0)) + 
                       (prices.IBIT * (parseFloat(inputs.qty_ibit) || 0)) + 
                       (parseFloat(inputs.cash_balance) || 0);
            }, [prices, inputs]);

            const analysis = useMemo(() => {
                const q = prices.QQQ;
                const { qqq_ema5: e5, qqq_ema12: e12, qqq_ema25: e25, qqq_ath: ath, current_positions: cur } = inputs;
                if (!q || !e25) return { rec: "æ•¸æ“šé€£ç·šä¸­...", msg: "è«‹æ›´æ–°é€±ç·šæ•¸å€¼æˆ–å¸‚åƒ¹ã€‚", level: "info" };

                const isBelowDeathLine = q < (e25 * 0.97);
                const isSlopeUp = e5 > e12;
                const drawdown = ath > 0 ? (ath - q) / ath : 0;
                const isSniperZone = drawdown > 0.08 && isSlopeUp;
                const isNearATH = q >= (ath * 0.98);

                let rec = "QLD (2x)";
                let msg = "è¶¨å‹¢æ­£å¸¸ï¼Œç¶­æŒ 2 å€æ§“æ¡¿å·¡èˆªæ¨¡å¼ã€‚";
                let level = "info";

                if (isBelowDeathLine) { rec = "CASH (å…¨ç¾é‡‘)"; msg = "âš ï¸ è·Œç ´ 25EMA ç”Ÿæ­»ç·šï¼ç«‹å³æ¸…å€‰é¿å´©ç›¤ã€‚"; level = "error"; }
                else if (isSniperZone) { rec = "TQQQ (3x)"; msg = "ğŸ”¥ æ·±å‘å›æ¸¬ > 8% ä¸”è¶¨å‹¢å‘ä¸Šï¼Œç‹™æ“Šé»è§¸ç™¼ã€‚"; level = "success"; }
                else if (!isSlopeUp) { rec = "QQQ (1x)"; msg = "ğŸ“‰ æ–œç‡å‘ä¸‹ï¼Œé™è‡³ 1x é¿é–‹ç›¤æ•´ç£¨æã€‚"; level = "warning"; }
                else if (cur === 'TQQQ' && (isNearATH || q < e5)) {
                    rec = "QLD (2x)";
                    msg = isNearATH ? "ğŸ’° ä¿®å¾©å·²é”é«˜é» 98%ï¼Œç²åˆ©çµæ¸…æ›å› QLDã€‚" : "âš ï¸ å‹•èƒ½æ¶ˆå¤± (ç ´ 5EMA)ï¼Œæ’¤é€€å› QLDã€‚";
                    level = "warning";
                }
                const actionLabel = cur === rec.split(' ')[0] ? "[çºŒæŠ±ä¸­]" : "[åŸ·è¡Œæ›å€‰]";
                return { rec: `${actionLabel} ${rec}`, msg, level };
            }, [prices, inputs]);

            useEffect(() => {
                auth.signInAnonymously().catch(console.error);
                const unsubAuth = auth.onAuthStateChanged(setUser);
                return () => unsubAuth();
            }, []);

            useEffect(() => {
                if (!effectiveUserId) return;
                const userDoc = db.collection('artifacts').doc(appId).collection('users').doc(effectiveUserId);
                
                const unsubRecs = userDoc.collection('trading_records').onSnapshot(snap => {
                    const r = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    r.sort((a,b) => new Date(b.date) - new Date(a.date));
                    setRecords(r);
                });

                const unsubConf = userDoc.collection('config').doc('current').onSnapshot(snap => {
                    if (snap.exists) {
                        const cloudData = snap.data();
                        setInputs(prev => ({ ...prev, ...cloudData, record_date: new Date().toISOString().split('T')[0] }));
                    }
                });
                return () => { unsubRecs(); unsubConf(); };
            }, [effectiveUserId]);

            const refreshPrices = async () => {
                if (loadingPrices) return;
                setLoadingPrices(true);
                const symbols = ['QQQ', 'QLD', 'TQQQ', 'IBIT'];
                const nP = { ...prices };
                try {
                    for (const s of symbols) {
                        const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=${s}&token=${FINNHUB_API_KEY}`);
                        const d = await res.json();
                        nP[s] = d.c || 0;
                    }
                    setPrices(nP);
                } catch (e) { console.error(e); } finally { setLoadingPrices(false); }
            };
            useEffect(() => { refreshPrices(); const i = setInterval(refreshPrices, 60000); return () => clearInterval(i); }, []);

            const save = async () => {
                if (!effectiveUserId) return;
                const d = new Date(inputs.record_date); d.setHours(12, 0, 0, 0);
                const record = { date: d.toISOString(), total_equity: totalCapital, core_pos: analysis.rec, sat_pos: prices.IBIT > inputs.ibit_ema50 ? 'IBIT' : 'CASH', prices: { ...prices }, inputs: { ...inputs } };
                try {
                    await db.collection('artifacts').doc(appId).collection('users').doc(effectiveUserId).collection('trading_records').add(record);
                    await db.collection('artifacts').doc(appId).collection('users').doc(effectiveUserId).collection('config').doc('current').set(inputs, { merge: true });
                    alert("å­˜æª”æˆåŠŸï¼æ•¸æ“šå·²åŒæ­¥è‡³é›²ç«¯è¨˜æ†¶ã€‚");
                } catch (e) { alert("å„²å­˜å¤±æ•—"); }
            };

            const startEdit = (rec) => { setEditingId(rec.id); setEditForm({ ...rec, date: rec.date.split('T')[0], inputs: rec.inputs || { ...inputs } }); };
            const updateRecord = async (id) => {
                const d = new Date(editForm.date); d.setHours(12, 0, 0, 0);
                const hP = editForm.prices || prices;
                const nT = (hP.QQQ * (parseFloat(editForm.inputs.qty_qqq) || 0)) + (hP.QLD * (parseFloat(editForm.inputs.qty_qld) || 0)) + (hP.TQQQ * (parseFloat(editForm.inputs.qty_tqqq) || 0)) + (hP.IBIT * (parseFloat(editForm.inputs.qty_ibit) || 0)) + (parseFloat(editForm.inputs.cash_balance) || 0);
                await db.collection('artifacts').doc(appId).collection('users').doc(effectiveUserId).collection('trading_records').doc(id).update({ date: d.toISOString(), inputs: editForm.inputs, total_equity: nT });
                setEditingId(null);
                alert("ä¿®æ”¹æˆåŠŸ");
            };

            const handleInputChange = (f, v) => setInputs(p => ({ ...p, [f]: (typeof p[f] === 'number') ? (v === '' ? 0 : parseFloat(v)) : v }));
            const syncToCloud = async (f, v) => {
                const val = (typeof inputs[f] === 'number') ? parseFloat(v) || 0 : v;
                await db.collection('artifacts').doc(appId).collection('users').doc(effectiveUserId).collection('config').doc('current').set({ [f]: val }, { merge: true });
            };

            const stats = useMemo(() => {
                if (records.length < 1) return { growth: 0, end: 0, list: [] };
                const filtered = records.filter(r => {
                    const d = new Date(r.date);
                    if (filterMode === 'year') return d.getFullYear() === new Date().getFullYear();
                    if (filterMode === 'month') return d.getFullYear() === new Date().getFullYear() && d.getMonth() === new Date().getMonth();
                    return true;
                });
                if (filtered.length < 1) return { growth: 0, end: 0, list: [] };
                const s = [...filtered].sort((a,b) => new Date(a.date) - new Date(b.date));
                const growth = s[0].total_equity > 0 ? ((s[s.length-1].total_equity - s[0].total_equity) / s[0].total_equity) * 100 : 0;
                return { growth, end: s[s.length-1].total_equity, list: filtered };
            }, [records, filterMode]);

            return (
                <div className="pb-36 overflow-x-hidden">
                    {/* Fixed Header */}
                    <header className="fixed top-0 left-0 right-0 bg-white/95 backdrop-blur-lg border-b z-50 px-5 py-4 flex justify-between items-center shadow-sm">
                        <div className="flex items-center gap-2">
                            <div className="bg-indigo-600 p-2 rounded-2xl shadow-lg"><Icon name="TrendingUp" className="text-white" size={18} /></div>
                            <h1 className="font-black text-lg tracking-tighter uppercase">QQQ Control</h1>
                        </div>
                        <div className="flex items-center gap-1">
                            <button onClick={() => setView('sync_settings')} className={`p-3 rounded-full transition-all ${view === 'sync_settings' ? 'text-indigo-600 bg-indigo-50' : 'text-slate-400'}`}><Icon name="Settings" size={22} /></button>
                            <button onClick={refreshPrices} className="p-3 text-slate-400 active:scale-90"><Icon name="RefreshCcw" size={22} className={loadingPrices ? 'animate-spin' : ''} /></button>
                        </div>
                    </header>

                    <main className="max-w-md mx-auto p-4 pt-24 space-y-6">
                        {view === 'sync_settings' && (
                            <div className="space-y-6 animate-in fade-in">
                                <Card className="bg-slate-900 text-white border-none p-6 shadow-2xl text-left relative overflow-hidden">
                                    <div className="absolute right-0 top-0 p-4 opacity-10"><Icon name="Fingerprint" size={100} /></div>
                                    <SectionTitle title="ç›®å‰ä½¿ç”¨ä¸­ ID" icon="Fingerprint" />
                                    <span className="text-lg font-black break-all tracking-tight leading-tight relative z-10">{effectiveUserId || 'æ­£åœ¨é€£çµæ•¸æ“šåº«...'}</span>
                                </Card>

                                <Card className="space-y-4">
                                    <SectionTitle title="åˆ‡æ›åŒæ­¥é‡‘é‘°" icon="CheckCircle" />
                                    <p className="text-xs text-slate-400 -mt-2">åœ¨ä¸åŒæ‰‹æ©Ÿè¼¸å…¥ç›¸åŒ IDï¼Œå³å¯åŒæ­¥æ‰€æœ‰é…ç½®èˆ‡è²¸æ¬¾è¨˜æ†¶ã€‚</p>
                                    <input type="text" value={tempSyncId} onChange={e => setTempSyncId(e.target.value)} className="w-full bg-slate-50 border-2 rounded-2xl p-5 font-black text-lg focus:border-indigo-500 outline-none transition-all" placeholder="è¼¸å…¥ ID" />
                                    <button onClick={() => { setCustomSyncId(tempSyncId.trim()); localStorage.setItem('qqq_sync_id', tempSyncId.trim()); setView('dashboard'); }} className="w-full bg-indigo-600 text-white py-5 rounded-2xl font-black text-lg shadow-xl active:scale-95 transition-all">å¥—ç”¨ ID ä¸¦æ¢å¾©é›²ç«¯æ•¸æ“š</button>
                                </Card>

                                <Card className="p-0 overflow-hidden border-2 shadow-sm text-left">
                                    <button onClick={() => setWhitepaperOpen(!isWhitepaperOpen)} className="w-full flex items-center justify-between p-5 bg-slate-50 font-black">
                                        <div className="flex items-center gap-2"><Icon name="Target" size={18} /><span>ç­–ç•¥åŸ·è¡Œå”è­° (æ–‡å­—ç‰ˆ)</span></div>
                                        <Icon name={isWhitepaperOpen ? "ChevronUp" : "ChevronDown"} size={20} />
                                    </button>
                                    {isWhitepaperOpen && (
                                        <div className="whitepaper-content p-6 text-[13px] space-y-6 leading-relaxed border-t bg-white">
                                            <div>
                                                <p className="text-emerald-600 font-black mb-2 flex items-center gap-1"><Icon name="ArrowRightCircle" size={14}/> è²¸æ¬¾åŠ ç¢¼é€²å ´å‚™è¨»ï¼š</p>
                                                <p className="pl-4 text-slate-500 font-medium leading-loose border-l-2 border-emerald-100">è‚¡åƒ¹å¿…é ˆã€Œå…ˆè·Œç ´é€±ç·š 25EMAã€ï¼Œéš¨å¾Œå†æ¬¡ã€Œæ¼²å›ç«™ç©© 25EMAã€ä¸” 5é€±å‡ç·šé«˜æ–¼ 12é€±å‡ç·šæ™‚ï¼Œæ–¹å¯å•Ÿå‹•è²¸æ¬¾åŠ ç¢¼è³‡é‡‘ã€‚</p>
                                            </div>
                                            <div className="space-y-3 pt-3 border-t border-slate-50">
                                                <p className="text-indigo-600 font-black flex items-center gap-1"><Icon name="ShieldAlert" size={14}/> æ ¸å¿ƒéƒ¨ä½æ“ä½œè¦å‰‡ï¼š</p>
                                                <ul className="pl-4 text-slate-500 space-y-3">
                                                    <li>â€¢ <strong>ç”Ÿæ­»ç”Ÿå­˜ï¼š</strong>æ”¶ç›¤è·Œç ´ 25EMA ä¹‹ 97% (-3%) ç«‹å³æ¸…å…¨å€‰ã€‚</li>
                                                    <li>â€¢ <strong>å¡åº¦å·¡èˆªï¼š</strong>5é€±é«˜æ–¼ 12é€±æŒæœ‰ 2x QLDï¼›åä¹‹æŒæœ‰ 1x QQQ é¿éœ‡ã€‚</li>
                                                    <li>â€¢ <strong>æ·±å‘ç‹™æ“Šï¼š</strong>å¤šé ­å›æ¸¬æ³¢æ®µé«˜é» > 8% æ™‚ï¼Œåˆ‡æ›è‡³ 3x TQQQã€‚</li>
                                                    <li>â€¢ <strong>ç²åˆ©é–åˆ©ï¼š</strong>TQQQ é”æ¨™é«˜é» 98% æˆ–è·Œç ´ 5EMA æ›å› QLDã€‚</li>
                                                </ul>
                                            </div>
                                            <div className="p-4 bg-slate-50 rounded-2xl italic text-slate-400 font-black tracking-widest text-center border border-slate-100 uppercase">ç´€å¾‹æ˜¯å”¯ä¸€æ·å¾‘</div>
                                        </div>
                                    )}
                                </Card>
                            </div>
                        )}

                        {view === 'dashboard' && (
                            <div className="space-y-6 animate-in fade-in">
                                <Card className="bg-indigo-50/50 border-dashed border-2 border-indigo-100 p-4 shadow-inner">
                                    <div className="flex gap-3 text-left">
                                        <Icon name="Quote" size={22} className="text-indigo-300 rotate-180 flex-shrink-0" />
                                        <textarea rows="2" placeholder="å¯«äº›è©±æ¿€å‹µè‡ªå·±..." value={inputs.motto} onChange={e => handleInputChange('motto', e.target.value)} onBlur={e => syncToCloud('motto', e.target.value)} className="w-full bg-transparent border-none focus:ring-0 p-0 text-[15px] font-black text-slate-700 italic outline-none resize-none leading-relaxed" />
                                    </div>
                                </Card>
                                
                                <Card className="bg-gradient-to-br from-slate-900 to-indigo-900 text-white border-none shadow-2xl p-7 text-left relative overflow-hidden">
                                    <div className="absolute -right-4 -bottom-4 opacity-5 rotate-12"><Icon name="BarChart3" size={160} /></div>
                                    <label className="text-[10px] font-black opacity-50 uppercase tracking-[0.2em] block mb-1">Portfolio Valuation</label>
                                    <div className="flex items-baseline gap-3 flex-wrap">
                                        <div className="text-4xl font-black tracking-tighter">${totalCapital.toLocaleString(undefined, { minimumFractionDigits: 2 })}</div>
                                        {inputs.loan_amount > 0 && <div className="text-xs font-black text-amber-400 bg-amber-400/20 px-3 py-1 rounded-full border border-amber-400/30">L: ${inputs.loan_amount.toLocaleString()}</div>}
                                    </div>
                                    <div className="text-[12px] opacity-30 font-bold tracking-widest mt-6 uppercase flex items-center gap-2"><Icon name="CheckCircle" size={14} /> æ·¨è³‡ç”¢: ${(totalCapital - inputs.loan_amount).toLocaleString()}</div>
                                </Card>

                                <Card className="grid grid-cols-2 gap-4">
                                    {[{ l: "QQQ", f: "qty_qqq", s: "QQQ" }, { l: "QLD", f: "qty_qld", s: "QLD" }, { l: "TQQQ", f: "qty_tqqq", s: "TQQQ" }, { l: "IBIT", f: "qty_ibit", s: "IBIT" }].map(it => (
                                        <div key={it.f} className="space-y-1 text-left">
                                            <div className="flex justify-between items-center px-1"><label className="text-[11px] font-black text-slate-400 uppercase">{it.l}</label><span className="text-[10px] font-black text-indigo-500 bg-indigo-50 px-2 py-0.5 rounded">${prices[it.s]?.toFixed(2)}</span></div>
                                            <input type="number" inputMode="decimal" value={inputs[it.f]} onChange={e => handleInputChange(it.f, e.target.value)} onBlur={e => syncToCloud(it.f, e.target.value)} className="w-full bg-slate-50 border-2 border-slate-50 rounded-2xl p-4 font-black text-lg focus:border-indigo-500 outline-none" />
                                        </div>
                                    ))}
                                    <div className="col-span-2 space-y-1 text-left"><label className="text-[11px] font-black text-slate-400 px-1 uppercase tracking-widest">ç¾é‡‘é¤˜é¡ (USD)</label><input type="number" inputMode="decimal" value={inputs.cash_balance} onChange={e => handleInputChange('cash_balance', e.target.value)} onBlur={(e) => syncToCloud('cash_balance', e.target.value)} className="w-full bg-slate-50 border-2 border-indigo-100/50 rounded-2xl p-4 font-black text-xl text-indigo-600 outline-none text-center shadow-inner" /></div>
                                </Card>

                                <Card className="grid grid-cols-2 gap-4">
                                    {[{ l: "EMA 5", f: "qqq_ema5" }, { l: "EMA 12", f: "qqq_ema12" }, { l: "EMA 25", f: "qqq_ema25" }, { l: "æ­·å²é«˜é»", f: "qqq_ath" }].map(it => (
                                        <div key={it.f} className="space-y-1 text-left"><label className="text-[11px] font-black text-slate-400 uppercase">{it.l}</label><input type="number" inputMode="decimal" value={inputs[it.f]} onChange={e => handleInputChange(it.f, e.target.value)} onBlur={(e) => syncToCloud(it.f, e.target.value)} className="w-full bg-slate-50 border-2 rounded-2xl p-4 font-black text-lg outline-none" /></div>
                                    ))}
                                </Card>

                                <Card className="p-2 shadow-inner">
                                    <select value={inputs.current_positions} onChange={e => { handleInputChange('current_positions', e.target.value); syncToCloud('current_positions', e.target.value); }} className="w-full bg-slate-50 rounded-xl p-5 font-black text-lg text-center appearance-none outline-none cursor-pointer">
                                        <option value="CASH">ğŸ’° æ‰‹æŒï¼šç¾é‡‘ (CASH)</option>
                                        <option value="QQQ">ğŸ“ˆ æ‰‹æŒï¼š1x QQQ</option>
                                        <option value="QLD">ğŸš€ æ‰‹æŒï¼š2x QLD</option>
                                        <option value="TQQQ">ğŸ”¥ æ‰‹æŒï¼š3x TQQQ</option>
                                    </select>
                                </Card>

                                <Card className={`border-l-[12px] shadow-xl text-left ${analysis.level === 'error' ? 'border-l-red-500 bg-red-50' : analysis.level === 'success' ? 'border-l-green-500 bg-green-50' : 'border-l-indigo-500 bg-indigo-50'}`}>
                                    <div className="flex items-start gap-4">
                                        <div className="p-4 rounded-3xl bg-white shadow-sm"><Icon name="ShieldAlert" size={36} className={analysis.level === 'error' ? 'text-red-500' : 'text-indigo-600'} /></div>
                                        <div className="space-y-2"><p className="text-2xl font-black tracking-tight leading-tight">{analysis.rec}</p><p className="text-[14px] font-bold opacity-80 leading-relaxed">{analysis.msg}</p></div>
                                    </div>
                                </Card>
                                
                                <button onClick={save} className="w-full bg-slate-900 text-white py-6 rounded-[2.5rem] font-black text-xl shadow-2xl active:scale-95 transition-all mb-12 flex items-center justify-center gap-3 tracking-widest"><Icon name="Save" size={24} /> å„²å­˜ç´€éŒ„è‡³é›²ç«¯</button>
                            </div>
                        )}

                        {view === 'loan' && (
                            <div className="space-y-6 animate-in fade-in text-left">
                                <Card className="space-y-6 border-2 border-amber-100 shadow-xl p-6">
                                    <div className="p-5 bg-amber-50 rounded-3xl flex items-start gap-4 shadow-sm border border-amber-100">
                                        <Icon name="Info" size={28} className="text-amber-600 flex-shrink-0" />
                                        <p className="text-[14px] text-amber-800 leading-relaxed font-black tracking-tight">åŠ ç¢¼å‰æï¼šè‚¡åƒ¹å¿…é ˆã€Œå…ˆè·Œç ´ 25EMAã€ï¼Œéš¨å¾Œå†æ¬¡ã€Œæ¼²å›ç«™ç©© 25EMAã€æ™‚æ–¹å¯å‹•ç”¨è³‡é‡‘ã€‚</p>
                                    </div>
                                    <div className="grid grid-cols-1 gap-6 text-left">
                                        {[{ l: "è²¸æ¬¾ç¸½é¡ (USD)", f: "loan_amount" }, { l: "å¹´åŒ–åˆ©ç‡ (%)", f: "loan_rate" }, { l: "è²¸æ¬¾æœŸé™ (å¹´)", f: "loan_years" }, { l: "é‚„æ¬¾ç²åˆ©ç›®æ¨™ (%)", f: "loan_repay_target" }].map(it => (
                                            <div key={it.f} className="space-y-2 text-left"><label className="text-[11px] font-black text-amber-600 uppercase tracking-widest px-1">{it.l}</label><input type="number" inputMode="decimal" value={inputs[it.f]} onChange={(e) => handleInputChange(it.f, e.target.value)} onBlur={(e) => syncToCloud(it.f, e.target.value)} className="w-full bg-amber-50 border-2 border-amber-100 rounded-[1.5rem] p-5 font-black text-xl outline-none shadow-inner" /></div>
                                        ))}
                                    </div>
                                    <div className="p-6 bg-amber-100/50 rounded-3xl border-2 border-dashed border-amber-200"><h4 className="text-sm font-black text-amber-800 mb-1 flex items-center gap-2"><Icon name="CreditCard" size={18}/> å„ªå…ˆå„Ÿé‚„è­¦ç¤º</h4><p className="text-[14px] text-amber-700 font-bold leading-relaxed tracking-tight">è³‡ç”¢å ±é…¬ç‡é” **{inputs.loan_repay_target}%** (${(totalCapital * (1 + inputs.loan_repay_target/100)).toLocaleString()}) æ™‚æ‡‰å„ªå…ˆæ¸…é‚„è²¸æ¬¾ã€‚</p></div>
                                </Card>
                            </div>
                        )}

                        {view === 'history' && (
                            <div className="space-y-6 animate-in fade-in">
                                <div className="flex gap-2 p-1.5 bg-slate-200 rounded-3xl shadow-inner">
                                    {['all', 'year', 'month'].map(m => (
                                        <button key={m} onClick={() => setFilterMode(m)} className={`flex-1 py-4 rounded-2xl text-xs font-black uppercase transition-all ${filterMode === m ? 'bg-white shadow text-indigo-600 scale-[1.02]' : 'text-slate-500'}`}>{m === 'all' ? 'å…¨éƒ¨' : m === 'year' ? 'å¹´åº¦' : 'æœ¬æœˆ'}</button>
                                    ))}
                                </div>
                                
                                <Card className="grid grid-cols-2 gap-4 py-8 text-center shadow-xl p-6 relative overflow-hidden">
                                    <div className="border-r border-slate-100"><span className="text-[10px] font-black text-slate-400 block mb-2 uppercase tracking-widest">å€é–“å ±é…¬</span><span className={`text-3xl font-black ${stats.growth >= 0 ? 'text-emerald-500' : 'text-red-500'}`}>{stats.growth >= 0 ? '+' : ''}{stats.growth.toFixed(2)}%</span></div>
                                    <div><span className="text-[10px] font-black text-slate-400 block mb-2 uppercase tracking-widest">è³‡ç”¢çµ‚å€¼</span><span className="text-2xl font-black text-slate-800 tracking-tighter">${stats.end.toLocaleString()}</span></div>
                                </Card>

                                <Card className="h-80 p-2 shadow-xl border-none overflow-hidden bg-white">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <AreaChart data={[...stats.list].reverse()} margin={{ top: 15, right: 10, left: 0, bottom: 25 }}>
                                            <defs><linearGradient id="colorEquity" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#6366f1" stopOpacity={0.4}/><stop offset="95%" stopColor="#6366f1" stopOpacity={0}/></linearGradient></defs>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                                            <XAxis dataKey="date" tickFormatter={v => new Date(v).toLocaleDateString('zh-TW', { month: 'numeric', day: 'numeric' })} tick={{ fontSize: 10, fontWeight: '900', fill: '#94a3b8' }} minTickGap={35} dy={15} />
                                            <YAxis tickFormatter={v => `$${(v/1000).toFixed(0)}k`} tick={{ fontSize: 10, fontWeight: '900', fill: '#94a3b8' }} width={50} />
                                            <Tooltip labelFormatter={v => new Date(v).toLocaleDateString()} />
                                            <Area type="monotone" dataKey="total_equity" stroke="#6366f1" strokeWidth={5} fillOpacity={1} fill="url(#colorEquity)" dot={{ r: 4, fill: '#6366f1', strokeWidth: 2, stroke: '#fff' }} />
                                        </AreaChart>
                                    </ResponsiveContainer>
                                </Card>

                                <div className="space-y-4 pb-28 text-left">
                                    {stats.list.map(rec => (
                                        <Card key={rec.id} className="border-none shadow-md overflow-hidden p-5">
                                            {editingId === rec.id ? (
                                                <div className="space-y-5 animate-in slide-in-from-top-1">
                                                    <div className="flex justify-between items-center border-b pb-3 text-indigo-600 font-black"><span className="text-sm uppercase tracking-widest">ä¿®æ”¹æ­·å²æŒå€‰</span><button onClick={() => setEditingId(null)} className="p-1"><Icon name="X" size={24} /></button></div>
                                                    <div className="grid grid-cols-2 gap-4 text-left text-slate-800">
                                                        <div className="col-span-2 space-y-1"><label className="text-[11px] font-black text-slate-400 uppercase tracking-widest px-1">æ—¥æœŸ</label><input type="date" value={editForm.date} onChange={e => setEditForm({...editForm, date: e.target.value})} className="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl p-4 font-black outline-none" /></div>
                                                        {['qty_qqq', 'qty_qld', 'qty_tqqq', 'qty_ibit', 'cash_balance'].map(f => (
                                                            <div key={f} className="space-y-1"><label className="text-[11px] font-black text-slate-400 uppercase tracking-widest px-1">{f.replace('qty_', '')}</label><input type="number" inputMode="decimal" value={editForm.inputs[f]} onChange={e => setEditForm({...editForm, inputs: {...editForm.inputs, [f]: e.target.value}})} className="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl p-4 font-black outline-none" /></div>
                                                        ))}
                                                    </div>
                                                    <button onClick={() => updateRecord(rec.id)} className="w-full bg-indigo-600 text-white py-5 rounded-3xl font-black text-lg shadow-xl active:scale-95 transition-all">å„²å­˜ä¸¦é‡ç®—ç¸½è³‡ç”¢</button>
                                                </div>
                                            ) : (
                                                <>
                                                    <div className="flex justify-between items-start">
                                                        <div className="space-y-1"><p className="text-[11px] font-black text-slate-400 uppercase tracking-widest">{new Date(rec.date).toLocaleDateString()}</p><p className="text-2xl font-black text-slate-800 dark:text-slate-100 tracking-tighter">${rec.total_equity?.toLocaleString()}</p></div>
                                                        <div className="flex gap-2 flex-wrap justify-end max-w-[130px]"><div className="px-3 py-1 bg-indigo-50 text-indigo-600 rounded-full text-[10px] font-black border border-indigo-100">{rec.core_pos?.split(' ')[1] || 'CASH'}</div><div className="px-3 py-1 bg-orange-50 text-orange-600 rounded-full text-[10px] font-black border border-orange-100">{rec.sat_pos}</div></div>
                                                    </div>
                                                    <div className="mt-6 flex justify-end gap-3 items-center">
                                                        {deletingId === rec.id ? (
                                                            <div className="flex gap-2 animate-in slide-in-from-right-2">
                                                                <span className="text-sm font-black text-red-500 pr-3">ç¢ºå®šåˆªé™¤ï¼Ÿ</span>
                                                                <button onClick={() => { db.collection('artifacts').doc(appId).collection('users').doc(effectiveUserId).collection('trading_records').doc(rec.id).delete(); setDeletingId(null); }} className="bg-red-500 text-white px-6 py-2.5 rounded-2xl text-sm font-black shadow-lg">æ˜¯</button>
                                                                <button onClick={() => setDeletingId(null)} className="bg-slate-200 px-6 py-2.5 rounded-2xl text-sm font-black">å¦</button>
                                                            </div>
                                                        ) : (
                                                            <><button onClick={() => startEdit(rec)} className="text-slate-300 p-3 rounded-full active:bg-slate-100 transition-all"><Icon name="Edit2" size={22} /></button><button onClick={() => setDeletingId(rec.id)} className="text-slate-300 hover:text-red-500 p-3 rounded-full active:bg-slate-100 transition-all"><Icon name="Trash2" size={22} /></button></>
                                                        )}
                                                    </div>
                                                </>
                                            )}
                                        </Card>
                                    ))}
                                </div>
                            </div>
                        )}
                    </main>

                    {/* å›ºå®š Footer Nav */}
                    <nav className="fixed bottom-0 left-0 right-0 bg-white border-t z-50 px-2 py-4 pb-10 flex justify-around items-center shadow-[0_-8px_30px_rgba(0,0,0,0.05)] safe-pb">
                        <button onClick={() => setView('dashboard')} className={`flex flex-col items-center gap-1.5 flex-1 relative transition-all active:scale-90 ${view === 'dashboard' ? 'active-tab' : 'text-slate-400'}`}>
                            <Icon name="LayoutDashboard" size={26} /><span className="text-[10px] font-black uppercase tracking-widest">å„€è¡¨æ¿</span>
                        </button>
                        <button onClick={() => setView('history')} className={`flex flex-col items-center gap-1.5 flex-1 relative transition-all active:scale-90 ${view === 'history' ? 'active-tab' : 'text-slate-400'}`}>
                            <Icon name="History" size={26} /><span className="text-[10px] font-black uppercase tracking-widest">ç¸¾æ•ˆ</span>
                        </button>
                        <button onClick={() => setView('loan')} className={`flex flex-col items-center gap-1.5 flex-1 relative transition-all active:scale-90 ${view === 'loan' ? 'text-amber-600' : 'text-slate-400'}`}>
                            <Icon name="Landmark" size={26} /><span className="text-[10px] font-black uppercase tracking-widest">è²¸æ¬¾</span>
                        </button>
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
